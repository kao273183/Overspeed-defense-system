<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜²æ‰£ç‰Œé è­¦ç³»çµ±</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow: hidden; 
            height: 100vh; height: 100dvh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            touch-action: manipulation;
            transition: background-color 0.1s;
        }

        /* ç‹€æ…‹é¡è‰² */
        body.danger { background-color: #b71c1c; animation: flash-red 0.5s infinite alternate; }
        @keyframes flash-red { from { background-color: #b71c1c; } to { background-color: #ff0000; } }
        
        body.warning { background-color: #fbc02d; animation: flash-yellow 0.8s infinite alternate; }
        body.warning #speed-display { color: #000; text-shadow: none; }
        body.warning .text-info { color: #333; }
        body.warning #location-display { background: rgba(0,0,0,0.8); color: #fff; } 
        @keyframes flash-yellow { from { background-color: #fbc02d; } to { background-color: #ffeb3b; } }

        /* --- é ‚éƒ¨å…ƒç´  (æ¼¢å ¡ã€æ™‚é˜ã€ä½ç½®) --- */
        #menu-btn {
            position: absolute; top: 20px; left: 20px;
            font-size: 2rem; background: none; border: none; color: #0f0; 
            cursor: pointer; z-index: 100; padding: 5px; opacity: 0.9;
        }

        #clock {
            position: absolute; top: 20px; right: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.5rem; font-weight: bold; color: #0f0;
            background: #222; padding: 5px 15px; border-radius: 8px;
            letter-spacing: 2px; z-index: 90;
        }

        #location-display {
            position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
            font-size: 1rem; color: #4caf50; 
            background: #333; 
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 80;
            max-width: 60%;
            display: flex; align-items: center; gap: 5px;
        }
        #location-display::before {
            content: 'ğŸ“';
            filter: hue-rotate(320deg); 
            font-size: 1.1rem;
        }

        /* --- å´é‚Šè¨­å®šæ¬„ --- */
        #settings-drawer {
            position: fixed; top: 0; left: 0;
            width: 85%; max-width: 350px; height: 100%;
            background: rgba(25, 25, 25, 0.98); 
            backdrop-filter: blur(15px);
            box-shadow: 4px 0 15px rgba(0,0,0,0.6);
            padding: 25px; box-sizing: border-box;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
            z-index: 200; overflow-y: auto;
            display: flex; flex-direction: column; gap: 25px; 
        }
        #settings-drawer.open { transform: translateX(0); }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; z-index: 150;
        }
        #overlay.show { display: block; }
        
        .drawer-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 15px; 
        }
        .drawer-title { font-size: 1.3rem; font-weight: bold; color: #eee; }
        .close-btn { background: none; border: none; color: #aaa; font-size: 1.8rem; cursor: pointer; padding: 0 5px; }

        /* --- ä¸»ç•«é¢ä½ˆå±€ --- */
        .main-container {
            display: flex; flex-direction: column; 
            align-items: center; justify-content: space-between; 
            width: 100%; height: 100%;
            padding: 10px; box-sizing: border-box;
            padding-top: 60px;
        }

        .dashboard {
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; width: 100%;
            transition: all 0.3s;
        }

        #speed-display {
            font-weight: bold; line-height: 1;
            text-shadow: 0 0 20px rgba(0,255,0,0.8);
            color: #0f0; 
            font-size: 28vh; 
            margin: 0; padding: 0;
            transition: color 0.2s;
            font-family: 'Arial Black', sans-serif;
        }
        #speed-display::after {
            content: 'km/h'; display: block; font-size: 1.5rem; 
            color: #0f0; text-align: center; font-weight: normal; margin-top: -10px;
            text-shadow: none; opacity: 0.8;
        }

        body.danger #speed-display { color: #fff; text-shadow: none; }
        body.danger #speed-display::after { color: #fff; }

        .info-area { 
            display: flex; align-items: center; gap: 20px; 
            margin-top: 10px; opacity: 0.9;
        }
        
        .limit-sign {
            width: 80px; height: 80px; background-color: #fff;
            border: 10px solid #cc0000; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #000; font-weight: bold; font-size: 36px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            font-family: Arial, sans-serif;
            transition: all 0.3s;
        }
        .limit-sign.unknown { border-color: #777; color: #777; }
        
        .threshold-info { display: flex; flex-direction: column; align-items: flex-start; }
        .threshold-badge { 
            color: #ffeb3b; border: 1px solid #555; padding: 4px 10px; 
            border-radius: 6px; background: rgba(0,0,0,0.6); font-size: 1rem; margin-bottom: 5px;
        }
        body.warning .threshold-badge { color: #000; border-color: #333; }
        .limit-source { font-size: 0.8rem; color: #4caf50; font-weight: bold; }

        /* --- åº•éƒ¨æ§åˆ¶å€ --- */
        .primary-controls { 
            width: 100%; max-width: 400px; 
            display: flex; flex-direction: column; gap: 10px; 
            background: #1c1c1e;
            padding: 15px; border-radius: 20px; margin-bottom: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        .control-group-left { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        
        .quick-presets { display: flex; gap: 8px; width: 100%; }
        .preset-btn { 
            background: #3a3a3c; color: #fff; border: none; 
            padding: 12px 0; font-size: 1rem; border-radius: 8px; flex: 1; 
            font-weight: bold;
        }
        .preset-btn:active { background: #555; }

        .adjust-row { display: flex; align-items: center; gap: 8px; height: 45px; }
        .adjust-btn { 
            background: #3a3a3c; color: white; border: none; 
            width: 60px; height: 100%; font-size: 1.2rem; border-radius: 8px; cursor: pointer; 
        }
        
        input[type="number"] { 
            flex-grow: 1; height: 100%; font-size: 1.5rem; font-weight: bold;
            border-radius: 8px; border: none; text-align: center; 
            background: #2c2c2e; color: #fff; padding: 0;
        }

        #toggle-btn {
            width: 100%; padding: 15px; font-size: 1.2rem; border: none;
            border-radius: 12px; cursor: pointer; font-weight: bold; color: white;
            background-color: #007aff; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #toggle-btn.active { background-color: #ff3b30; }

        /* --- è¨­å®šé¸å–®å…ƒä»¶ --- */
        .input-group { text-align: left; width: 100%; }
        .input-group label { display: block; color: #bbb; font-size: 0.95rem; margin-bottom: 8px; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #555; background: #333; color: #fff; box-sizing: border-box; }
        .file-upload { position: relative; overflow: hidden; display: block; width: 100%; }
        .file-upload input[type="file"] { position: absolute; top: 0; right: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-btn { background-color: #333; color: #ddd; padding: 12px; border-radius: 8px; display: block; text-align: center; border: 1px dashed #777; font-size: 0.9rem; }
        .drawer-btn { width: 100%; padding: 12px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; color: white; margin-top: 10px; font-weight: bold; }
        #test-file-btn { background-color: #ff9800; }
        #test-tts-btn { background-color: #28a745; }
        #pip-btn { background-color: #9c27b0; }
        #status { margin-top: auto; padding-bottom: 10px; font-size: 0.8rem; color: #666; text-align: center; }
        #pip-canvas { display: none; }
        #pip-video { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; }

        /* =========================================
           ğŸ“± æ©«å‘æ¨¡å¼ (Landscape)
           ========================================= */
        @media (orientation: landscape) {
            .main-container {
                padding: 10px 40px; 
                padding-top: 60px;
                justify-content: flex-end; 
            }
            .dashboard {
                flex-direction: row; 
                align-items: center;
                justify-content: center;
                gap: 50px; 
                margin-bottom: 15px; 
            }
            #speed-display {
                font-size: 40vh; 
                text-align: center;
                line-height: 0.9;
            }
            .info-area {
                margin-top: 0;
                flex-direction: row; 
            }
            .limit-sign {
                width: 130px; 
                height: 130px; 
                font-size: 60px; 
                border-width: 12px; 
            }
            .primary-controls {
                max-width: 850px;
                width: 95%;
                flex-direction: row; 
                align-items: stretch;
                padding: 10px 20px; 
                background: #1c1c1e;
                gap: 15px;
            }
            .control-group-left {
                flex: 2;
                justify-content: space-between;
                gap: 6px; 
            }
            #toggle-btn {
                flex: 1;
                font-size: 1.4rem;
                height: auto; 
            }
            .preset-btn { padding: 8px 0; font-size: 0.9rem; }
            .adjust-row { height: 40px; }
        }
    </style>
</head>
<body>

    <button id="menu-btn" onclick="toggleMenu()">â˜°</button>
    <div id="location-display">ğŸ“ å®šä½ä¸­...</div> 
    <div id="clock">--:--</div>

    <canvas id="pip-canvas" width="512" height="512"></canvas>
    <video id="pip-video" muted playsinline></video>

    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="settings-drawer">
        <div class="drawer-header">
            <span class="drawer-title">é€²éšè¨­å®š</span>
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
        </div>
        <div class="input-group">
            <label>é¡¯ç¤ºæ¨¡å¼</label>
            <button class="drawer-btn" id="pip-btn">ğŸ“º é–‹å•Ÿå­æ¯ç•«é¢ (PiP)</button>
        </div>
        <div class="input-group">
            <label>OSM è‡ªå‹•é€Ÿé™</label>
            <div style="display: flex; align-items: center; gap: 10px; background: #333; padding: 10px; border-radius: 8px;">
                <input type="checkbox" id="auto-limit-check" checked style="width: 20px; height: 20px; accent-color: #2979ff;"> 
                <span style="font-size: 1rem; color: #fff;">å•Ÿç”¨è‡ªå‹•åµæ¸¬</span>
            </div>
        </div>
        <div class="input-group">
            <label>åš´é‡è¶…é€ŸèªéŸ³ (TTS)</label>
            <input type="text" id="voice-text" value="åš´é‡è¶…é€Ÿï¼è«‹ç…è»Š">
            <button class="drawer-btn" id="test-tts-btn">ğŸ—£ï¸ æ¸¬è©¦èªéŸ³</button>
        </div>
        <div class="input-group">
            <label>è­¦ç¤ºéŸ³æ•ˆ (é»ƒè‰²é è­¦ç”¨)</label>
            <div class="file-upload">
                <div class="file-btn" id="file-label">ğŸ“‚ æ›´æ›éŸ³æ•ˆ (é è¨­ sound.mp3)</div>
                <input type="file" id="sound-upload" accept="audio/*">
            </div>
            <button class="drawer-btn" id="test-file-btn">ğŸ”Š æ¸¬è©¦éŸ³æ•ˆ</button>
        </div>
        <div id="status">æº–å‚™å°±ç·’</div>
    </div>

    <div class="main-container">
        
        <div class="dashboard">
            <div id="speed-display">0</div> 
            
            <div class="info-area">
                <div id="visual-limit" class="limit-sign unknown">50</div>
                <div class="threshold-info">
                    <div class="threshold-badge">
                        æ‰£ç‰Œ: <span id="alarm-threshold-text">88</span>
                    </div>
                    <span id="limit-source-text" class="limit-source">æ‰‹å‹•è¨­å®š</span>
                </div>
            </div>
        </div>

        <div class="primary-controls">
            <div class="control-group-left">
                <div class="quick-presets">
                    <button class="preset-btn" onclick="setLimit(30)">30</button>
                    <button class="preset-btn" onclick="setLimit(40)">40</button>
                    <button class="preset-btn" onclick="setLimit(50)">50</button>
                </div>

                <div class="adjust-row">
                    <button class="adjust-btn" id="btn-minus">-10</button> 
                    <input type="number" id="limit-input" value="50">
                    <button class="adjust-btn" id="btn-plus">+10</button> 
                </div>
            </div>

            <button id="toggle-btn">ğŸš€ å•Ÿå‹•åµæ¸¬</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const speedDisplay = document.getElementById('speed-display');
        const locationDisplay = document.getElementById('location-display');
        const limitInput = document.getElementById('limit-input');
        const visualLimit = document.getElementById('visual-limit');
        const limitSourceText = document.getElementById('limit-source-text');
        const alarmThresholdText = document.getElementById('alarm-threshold-text');
        
        const voiceTextInput = document.getElementById('voice-text');
        const soundUpload = document.getElementById('sound-upload');
        const fileLabel = document.getElementById('file-label');

        const toggleBtn = document.getElementById('toggle-btn');
        const testFileBtn = document.getElementById('test-file-btn');
        const testTtsBtn = document.getElementById('test-tts-btn');
        const btnMinus = document.getElementById('btn-minus');
        const btnPlus = document.getElementById('btn-plus');
        const clockEl = document.getElementById('clock');
        const pipBtn = document.getElementById('pip-btn');

        const statusDiv = document.getElementById('status');
        const autoLimitCheck = document.getElementById('auto-limit-check');
        const drawer = document.getElementById('settings-drawer');
        const overlay = document.getElementById('overlay');
        const body = document.body;

        // PiP Elements
        const pipCanvas = document.getElementById('pip-canvas');
        const pipCtx = pipCanvas.getContext('2d');
        const pipVideo = document.getElementById('pip-video');

        let watchId = null;
        let wakeLock = null;
        let lastSpeakTime = 0;
        let lastBeepTime = 0; 
        
        // isMonitoring ç¾åœ¨ä»£è¡¨ã€Œæ˜¯å¦é–‹å•Ÿè­¦å ±æ¨¡å¼ã€
        // å°±ç®—ç‚º falseï¼ŒGPS ä¹Ÿæœƒåœ¨èƒŒæ™¯åŸ·è¡Œ
        let isMonitoring = false; 
        
        let lastOsmCheckTime = 0;
        let lastAddressCheckTime = 0; 
        
        const TOLERANCE = 38; 
        const PRE_WARNING_BUFFER = 5; 
        
        const synth = window.speechSynthesis;

        // --- æ™‚é˜åŠŸèƒ½ ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            clockEl.textContent = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock(); 

        // 1. ç„¡è²èƒŒæ™¯éŸ³æ¨‚
        const silentAudio = new Audio();
        silentAudio.src = "data:audio/mp3;base64,SUQzBAAAAAABAFRYWFQAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhUAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhUAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==";
        silentAudio.loop = true;
        silentAudio.volume = 0.01; 

        // 2. è­¦å ±éŸ³æ•ˆ
        let beepAudio = new Audio();
        const DEFAULT_SOUND_PATH = './sound.mp3';

        function makeDefaultBeep() {
            const sampleRate = 44100;
            const duration = 0.5; 
            const numSamples = duration * sampleRate;
            const buffer = new Uint8Array(44 + numSamples);
            const view = new DataView(buffer.buffer);
            const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + numSamples, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate, true); view.setUint16(32, 1, true); view.setUint16(34, 8, true); writeString(view, 36, 'data'); view.setUint32(40, numSamples, true);
            const frequency = 880; 
            for (let i = 0; i < numSamples; i++) {
                const t = i / sampleRate;
                const sample = (Math.sin(2 * Math.PI * frequency * t) > 0 ? 200 : 55); 
                view.setUint8(44 + i, sample);
            }
            return URL.createObjectURL(new Blob([buffer], { type: 'audio/wav' }));
        }

        function initSound() {
            beepAudio.src = DEFAULT_SOUND_PATH;
            beepAudio.onerror = function() {
                fileLabel.textContent = "âš ï¸ ç„¡ sound.mp3 (ç”¨é è¨­éŸ³)";
                beepAudio.src = makeDefaultBeep();
            };
            beepAudio.oncanplaythrough = function() {
                fileLabel.textContent = "âœ… å·²è¼‰å…¥ sound.mp3";
                fileLabel.style.borderColor = "#28a745";
            };
        }
        initSound();

        // é è¨­æ›´æ–°
        updateVisualSign(50, false);
        updateThresholdDisplay();
        updatePiP(0, 50);

        // --- PiP å­æ¯ç•«é¢é‚è¼¯ ---
        function updatePiP(currentSpeed, limit) {
            pipCtx.fillStyle = '#000000';
            pipCtx.fillRect(0, 0, 512, 512);

            const baseLimit = parseInt(limit) || 0;
            const alarmTrigger = baseLimit + TOLERANCE;
            const preWarningStart = alarmTrigger - PRE_WARNING_BUFFER;
            let bgColor = '#000000';
            
            // åªæœ‰åœ¨é–‹å•Ÿç›£æ§ (isMonitoring) æ™‚æ‰é¡¯ç¤ºè­¦å‘Šé¡è‰²
            if (isMonitoring) {
                if (currentSpeed > alarmTrigger) bgColor = '#b71c1c'; 
                else if (currentSpeed > preWarningStart) bgColor = '#fbc02d'; 
            }

            if (bgColor !== '#000000') {
                pipCtx.fillStyle = bgColor;
                pipCtx.fillRect(0, 0, 512, 512);
            }

            pipCtx.fillStyle = (bgColor === '#b71c1c') ? '#ffffff' : (bgColor === '#fbc02d' ? '#000000' : '#00ff00');
            pipCtx.font = 'bold 250px Arial';
            pipCtx.textAlign = 'center';
            pipCtx.textBaseline = 'middle';
            pipCtx.fillText(Math.round(currentSpeed), 256, 200);

            pipCtx.beginPath();
            pipCtx.arc(256, 400, 70, 0, 2 * Math.PI);
            pipCtx.fillStyle = '#ffffff';
            pipCtx.fill();
            pipCtx.lineWidth = 10;
            pipCtx.strokeStyle = '#cc0000';
            pipCtx.stroke();
            pipCtx.fillStyle = '#000000';
            pipCtx.font = 'bold 60px Arial';
            pipCtx.fillText(baseLimit, 256, 403);
        }

       pipBtn.addEventListener('click', async () => {
            if (typeof pipCanvas.captureStream !== 'function') {
                alert("âš ï¸ å¾ˆæŠ±æ­‰ï¼ŒiPhone (iOS) ç³»çµ±ä¸æ”¯æ´ã€Œç¶²é ç•«å¸ƒè½‰å½±ç‰‡ã€æŠ€è¡“ï¼Œå› æ­¤ç„¡æ³•ä½¿ç”¨å­æ¯ç•«é¢ã€‚\n\nï¼ˆé€™æ˜¯ Apple çš„ç³»çµ±é™åˆ¶ï¼Œç›®å‰åƒ… Android æ‰‹æ©Ÿæˆ–é›»è…¦ç‰ˆ Chrome æ”¯æ´æ­¤åŠŸèƒ½ï¼‰");
                return;
            }

            try {
                updatePiP(0, limitInput.value);
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                    return;
                }
                if (!pipVideo.srcObject) {
                    const stream = pipCanvas.captureStream(30);
                    pipVideo.srcObject = stream;
                }
                await pipVideo.play();
                if (pipVideo.readyState >= 1) {
                    await pipVideo.requestPictureInPicture();
                } else {
                    pipVideo.onloadedmetadata = async () => {
                        await pipVideo.requestPictureInPicture();
                    };
                }
                toggleMenu();
            } catch (err) {
                alert("ç„¡æ³•å•Ÿå‹•å­æ¯ç•«é¢ (ç€è¦½å™¨ä¸æ”¯æ´æˆ–æ¬Šé™ä¸è¶³)\néŒ¯èª¤: " + err.message);
                console.error(err);
            }
        });

        // --- UI æ“ä½œé‚è¼¯ ---
        window.toggleMenu = function() {
            drawer.classList.toggle('open');
            if (drawer.classList.contains('open')) {
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        };

        window.setLimit = function(val) {
            limitInput.value = val;
            updateVisualSign(val, false);
            updateThresholdDisplay();
            updatePiP(0, val);
        };

        btnMinus.addEventListener('click', () => {
            let current = parseInt(limitInput.value) || 0;
            current = Math.max(0, current - 10);
            limitInput.value = current;
            updateVisualSign(current, false);
            updateThresholdDisplay();
            updatePiP(0, current);
        });

        btnPlus.addEventListener('click', () => {
            let current = parseInt(limitInput.value) || 0;
            current = current + 10;
            limitInput.value = current;
            updateVisualSign(current, false);
            updateThresholdDisplay();
            updatePiP(0, current);
        });

        soundUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const objectUrl = URL.createObjectURL(file);
                beepAudio.src = objectUrl;
                beepAudio.onerror = null; 
                fileLabel.textContent = `ğŸ“‚ ä½¿ç”¨: ${file.name}`;
                fileLabel.style.backgroundColor = "#28a745";
                playCustomSound();
            }
        });

        function playCustomSound() {
            beepAudio.currentTime = 0;
            beepAudio.play().catch(e => console.log("Sound error", e));
        }

        testFileBtn.addEventListener('click', () => {
            playCustomSound();
        });

        testTtsBtn.addEventListener('click', () => {
            playCustomSound();
            setTimeout(() => { speak(voiceTextInput.value || "æ¸¬è©¦èªéŸ³"); }, 1000);
        });

        // æŒ‰éˆ•é‚è¼¯è®Šæ›´ï¼šåªåˆ‡æ›ã€Œè­¦å ±ç‹€æ…‹ã€ï¼Œä¸è² è²¬é–‹é—œ GPS
        toggleBtn.addEventListener('click', () => {
            silentAudio.play().catch(()=>{}); // ç”¨æˆ¶æ‰‹å‹¢è§£é–éŸ³æ•ˆ
            if (!isMonitoring) {
                startActiveMonitoring();
            } else {
                stopActiveMonitoring();
            }
        });

        limitInput.addEventListener('input', () => {
            updateVisualSign(limitInput.value, false);
            updateThresholdDisplay();
            updatePiP(0, limitInput.value);
        });

        function updateThresholdDisplay() {
            const base = parseInt(limitInput.value) || 0;
            alarmThresholdText.textContent = base + TOLERANCE;
        }

        async function requestWakeLock() {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') { await requestWakeLock(); }
        });

        // é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œçš„ GPS å•Ÿå‹•å‡½å¼
        function initGPS() {
            if (navigator.geolocation) {
                statusDiv.textContent = "å®šä½ä¸­ (ç›£æ§å¾…å‘½)";
                locationDisplay.textContent = "å®šä½ä¸­...";
                watchId = navigator.geolocation.watchPosition(updatePosition, handleError, {
                    enableHighAccuracy: true, timeout: 5000, maximumAge: 0
                });
            } else {
                alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS");
            }
        }
        // é¦¬ä¸ŠåŸ·è¡Œ
        initGPS();

        async function startActiveMonitoring() {
            silentAudio.play().catch(()=>{});
            playCustomSound();
            setTimeout(() => { speak("åµæ¸¬é–‹å§‹"); }, 800);
            await requestWakeLock();

            isMonitoring = true; // é–‹å•Ÿè­¦å ±æ¨™è¨˜
            toggleBtn.textContent = "ğŸ›‘ åœæ­¢åµæ¸¬";
            toggleBtn.classList.add('active');
            statusDiv.textContent = "âš ï¸ ç›£æ§ä¸­";
        }

        function stopActiveMonitoring() {
            if (wakeLock !== null) wakeLock.release();
            silentAudio.pause();
            
            isMonitoring = false; // é—œé–‰è­¦å ±æ¨™è¨˜
            toggleBtn.textContent = "ğŸš€ å•Ÿå‹•åµæ¸¬";
            toggleBtn.classList.remove('active');
            
            // ç§»é™¤ç•«é¢ä¸Šçš„ç´…è‰²/é»ƒè‰²è­¦å‘Šï¼Œè®Šå›é»‘è‰²
            body.classList.remove('danger');
            body.classList.remove('warning');
            
            statusDiv.textContent = "å·²æš«åœ (å®šä½æŒçºŒä¸­)";
            // æ³¨æ„ï¼šæˆ‘å€‘æ²’æœ‰æ¸…é™¤ watchIdï¼Œæ‰€ä»¥ä½ç½®å’Œæ™‚é€Ÿæœƒç¹¼çºŒæ›´æ–°
        }

        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            let speedMps = position.coords.speed;
            if (speedMps === null || speedMps < 0) speedMps = 0;
            const speedKmh = speedMps * 3.6;

            speedDisplay.innerHTML = `${Math.round(speedKmh)}`;
            
            const now = Date.now();
            
            // OSM é™é€Ÿæ›´æ–° (15ç§’ä¸€æ¬¡)
            if (autoLimitCheck.checked && (now - lastOsmCheckTime > 15000) && speedKmh > 10) {
                fetchSpeedLimit(lat, lon);
                lastOsmCheckTime = now;
            }
            
            // åœ°å€æ›´æ–° (15ç§’ä¸€æ¬¡)
            if (now - lastAddressCheckTime > 15000) {
                fetchAddress(lat, lon);
                lastAddressCheckTime = now;
            }
            
            checkOverSpeed(speedKmh);
            updatePiP(speedKmh, limitInput.value);
        }

        function checkOverSpeed(currentSpeed) {
            // å¦‚æœæ²’é–‹å•Ÿç›£æ§ï¼Œå°±ä¸åšä»»ä½•è­¦å ±ï¼Œç›´æ¥æ¸…é™¤æ¨£å¼ä¸¦è¿”å›
            if (!isMonitoring) {
                body.classList.remove('danger');
                body.classList.remove('warning');
                return;
            }

            const baseLimit = parseFloat(limitInput.value);
            const alarmTrigger = baseLimit + TOLERANCE; 
            const preWarningStart = alarmTrigger - PRE_WARNING_BUFFER; 
            const now = Date.now();

            if (currentSpeed > alarmTrigger) {
                body.classList.remove('warning');
                body.classList.add('danger');
                if (now - lastSpeakTime > 3000) { 
                    playCustomSound(); 
                    setTimeout(() => speak(voiceTextInput.value), 1000);
                    lastSpeakTime = now;
                }
            } else if (currentSpeed > preWarningStart) {
                body.classList.remove('danger');
                body.classList.add('warning');
                if (now - lastBeepTime > 1000) {
                    playCustomSound(); 
                    lastBeepTime = now;
                }
            } else {
                body.classList.remove('danger');
                body.classList.remove('warning');
            }
        }

        // æŠ“å–åœ°å€åŠŸèƒ½ (Nominatim)
        async function fetchAddress(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=zh-TW`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.address) {
                    const road = data.address.road || data.address.pedestrian || data.address.cycleway || "";
                    const suburb = data.address.suburb || data.address.village || data.address.town || data.address.city_district || "";
                    const city = data.address.city || data.address.county || "";
                    
                    let displayText = "";
                    if (road) {
                        displayText = `${suburb} ${road}`;
                    } else if (suburb) {
                        displayText = `${city} ${suburb}`;
                    } else {
                        displayText = `${city}`;
                    }
                    locationDisplay.textContent = displayText.trim();
                } else {
                    locationDisplay.textContent = "ç„¡æ³•è¾¨è­˜ä½ç½®";
                }
            } catch (err) {
                console.warn("Address fetch failed", err);
            }
        }

        async function fetchSpeedLimit(lat, lon) {
            const query = `[out:json];way[maxspeed](around:20,${lat},${lon});out tags;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.elements && data.elements.length > 0) {
                    let maxspeed = data.elements[0].tags.maxspeed;
                    let limitNumber = parseInt(maxspeed);
                    if (maxspeed.includes("mph")) limitNumber = Math.round(limitNumber * 1.609);
                    if (!isNaN(limitNumber)) {
                        limitInput.value = limitNumber; 
                        updateVisualSign(limitNumber, true);
                        updateThresholdDisplay();
                        updatePiP(0, limitNumber);
                    }
                }
            } catch (err) {}
        }

        function updateVisualSign(val, isAuto) {
            if (val && val > 0) {
                visualLimit.textContent = val;
                visualLimit.classList.remove('unknown');
                limitSourceText.innerHTML = isAuto ? "OSM è‡ªå‹•" : "æ‰‹å‹•è¨­å®š";
                limitSourceText.style.color = isAuto ? "#4caf50" : "#aaa";
            } else {
                visualLimit.textContent = "--";
                visualLimit.classList.add('unknown');
            }
        }

        function speak(text) {
            if (synth.speaking) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.1; 
            const voices = synth.getVoices();
            const targetVoice = voices.find(v => v.name.includes("Google") && v.lang.includes("zh")) 
                             || voices.find(v => v.lang.includes("zh"));     
            if (targetVoice) utterance.voice = targetVoice;
            synth.speak(utterance);
        }

        function handleError(error) {
            console.warn(`GPS Error: ${error.message}`);
            statusDiv.textContent = "âŒ GPS è¨Šè™Ÿéºå¤±";
            locationDisplay.textContent = "GPS éºå¤±";
        }
        
        window.speechSynthesis.onvoiceschanged = () => {};
    </script>
</body>
</html>