<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜²æ‰£ç‰Œé è­¦ç³»çµ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow: hidden; 
            height: 100vh; height: 100dvh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            touch-action: manipulation;
            transition: background-color 0.1s;
        }

        /* ç‹€æ…‹é¡è‰² */
        body.danger { background-color: #b71c1c; animation: flash-red 0.5s infinite alternate; }
        @keyframes flash-red { from { background-color: #b71c1c; } to { background-color: #ff0000; } }
        
        body.warning { background-color: #fbc02d; animation: flash-yellow 0.8s infinite alternate; }
        body.warning #speed-display { color: #000; text-shadow: none; }
        body.warning .text-info { color: #333; }
        body.warning #location-display { background: rgba(0,0,0,0.8); color: #fff; } 
        @keyframes flash-yellow { from { background-color: #fbc02d; } to { background-color: #ffeb3b; } }

        /* --- é ‚éƒ¨å…ƒç´  --- */
        #menu-btn {
            position: absolute; top: 20px; left: 20px;
            font-size: 2rem; background: none; border: none; color: #0f0; 
            cursor: pointer; z-index: 100; padding: 5px; opacity: 0.9;
        }

        #clock {
            position: absolute; top: 20px; right: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.5rem; font-weight: bold; color: #0f0;
            background: #222; padding: 5px 15px; border-radius: 8px;
            letter-spacing: 2px; z-index: 90;
        }

        #location-display {
            position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
            font-size: 1rem; color: #4caf50; 
            background: #333; 
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 80;
            max-width: 60%;
            display: flex; align-items: center; gap: 5px;
        }
        #location-display::before { content: 'ğŸ“'; filter: hue-rotate(320deg); font-size: 1.1rem; }

        /* --- å´é‚Šè¨­å®šæ¬„ --- */
        #settings-drawer {
            position: fixed; top: 0; left: 0;
            width: 85%; max-width: 350px; height: 100%;
            background: rgba(25, 25, 25, 0.98); 
            backdrop-filter: blur(15px);
            box-shadow: 4px 0 15px rgba(0,0,0,0.6);
            padding: 25px; box-sizing: border-box;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
            z-index: 200; overflow-y: auto;
            display: flex; flex-direction: column; gap: 25px; 
        }
        #settings-drawer.open { transform: translateX(0); }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; z-index: 150;
        }
        #overlay.show { display: block; }
        
        .drawer-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 15px; 
        }
        .drawer-title { font-size: 1.3rem; font-weight: bold; color: #eee; }
        .close-btn { background: none; border: none; color: #aaa; font-size: 1.8rem; cursor: pointer; padding: 0 5px; }

        /* --- Modal å…±ç”¨ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.show { display: flex; }
        .modal-container {
            width: 90%; max-width: 500px; height: 85%;
            background: #1c1c1e; border-radius: 20px;
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid #333;
        }
        .history-header {
            padding: 20px; background: #2c2c2e; font-weight: bold; font-size: 1.2rem;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #444;
        }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item {
            background: #2c2c2e; margin-bottom: 10px; padding: 15px;
            border-radius: 12px; display: flex; flex-direction: column; gap: 8px;
        }
        .h-date { color: #888; font-size: 0.8rem; }
        .h-stats { display: flex; justify-content: space-between; font-size: 1rem; font-weight: bold; margin-top: 5px; }
        .h-stat-box { text-align: center; }
        .h-label { font-size: 0.7rem; color: #aaa; display: block; }
        .h-val { color: #fff; }
        .h-val.max { color: #ff3b30; }
        .empty-msg { text-align: center; color: #666; margin-top: 50px; }
        .btn-link { 
            background: #28a745; color: white; border: none; padding: 6px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 0.8rem; text-decoration: none; display:inline-block;
        }
        .btn-set-speed {
            background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px;
            margin-right: 5px; border-radius: 5px; cursor: pointer;
        }
        .btn-set-speed:hover { background: #666; }
        
        /* åœ°åœ– Modal */
        #map-container { flex: 1; width: 100%; position: relative; }
        #trip-map { width: 100%; height: 100%; background: #000; }
        .back-btn { 
            position: absolute; top: 20px; right: 20px; left: auto; z-index: 2000;
            background: #007aff; color: #fff; border: none;
            padding: 10px 24px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); transition: transform 0.1s;
        }
        .back-btn:active { transform: scale(0.95); }

        /* --- ä¸»ç•«é¢ä½ˆå±€ --- */
        .main-container {
            display: flex; flex-direction: column; 
            align-items: center; justify-content: space-between; 
            width: 100%; height: 100%; padding: 10px; box-sizing: border-box; padding-top: 60px;
        }
        .dashboard {
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; width: 100%; transition: all 0.3s;
        }
        #speed-display {
            font-weight: bold; line-height: 1; text-shadow: 0 0 20px rgba(0,255,0,0.8);
            color: #0f0; font-size: 28vh; margin: 0; padding: 0; transition: color 0.2s;
            font-family: 'Arial Black', sans-serif;
        }
        #speed-display::after {
            content: 'km/h'; display: block; font-size: 1.5rem; 
            color: #0f0; text-align: center; font-weight: normal; margin-top: -10px; text-shadow: none; opacity: 0.8;
        }
        body.danger #speed-display { color: #fff; text-shadow: none; }
        body.danger #speed-display::after { color: #fff; }

        .info-area { display: flex; align-items: center; gap: 20px; margin-top: 10px; opacity: 0.9; }
        
        /* é€Ÿé™ç‰Œèˆ‡å›å ±æŒ‰éˆ•å®¹å™¨ */
        .limit-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        
        .limit-sign {
            width: 80px; height: 80px; background-color: #fff;
            border: 10px solid #cc0000; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #000; font-weight: bold; font-size: 36px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); font-family: Arial, sans-serif; transition: all 0.3s;
        }
        .limit-sign.unknown { border-color: #777; color: #777; font-size: 40px; } /* å•è™Ÿæ™‚å­—é«” */
        
        /* å›å ±æŒ‰éˆ• (ç•¶é€Ÿé™æœªçŸ¥æ™‚é¡¯ç¤º) */
        #report-btn {
            margin-top: 10px; background: #ff9800; color: #000; font-weight: bold;
            border: none; padding: 8px 16px; border-radius: 20px; font-size: 1rem;
            cursor: pointer; display: none; animation: pop 0.3s ease-out; box-shadow: 0 0 10px #ff9800;
        }
        #report-btn:active { transform: scale(0.95); }
        @keyframes pop { from {transform: scale(0);} to {transform: scale(1);} }

        .threshold-info { display: flex; flex-direction: column; align-items: flex-start; }
        .threshold-badge { 
            color: #ffeb3b; border: 1px solid #555; padding: 4px 10px; 
            border-radius: 6px; background: rgba(0,0,0,0.6); font-size: 1rem; margin-bottom: 5px;
        }
        body.warning .threshold-badge { color: #000; border-color: #333; }
        .limit-source { font-size: 0.8rem; color: #4caf50; font-weight: bold; }

        /* --- åº•éƒ¨æ§åˆ¶å€ --- */
        .primary-controls { 
            width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; 
            background: #1c1c1e; padding: 15px; border-radius: 20px; margin-bottom: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); transition: all 0.3s;
        }
        .control-group-left { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .quick-presets { display: flex; gap: 8px; width: 100%; }
        .preset-btn { 
            background: #3a3a3c; color: #fff; border: none; padding: 12px 0; 
            font-size: 1rem; border-radius: 8px; flex: 1; font-weight: bold;
        }
        .preset-btn:active { background: #555; }
        .adjust-row { display: flex; align-items: center; gap: 8px; height: 45px; }
        .adjust-btn { 
            background: #3a3a3c; color: white; border: none; width: 60px; height: 100%; 
            font-size: 1.2rem; border-radius: 8px; cursor: pointer; 
        }
        input[type="number"] { 
            flex-grow: 1; height: 100%; font-size: 1.5rem; font-weight: bold;
            border-radius: 8px; border: none; text-align: center; background: #2c2c2e; color: #fff; padding: 0;
        }
        #toggle-btn {
            width: 100%; padding: 15px; font-size: 1.2rem; border: none; border-radius: 12px; cursor: pointer; 
            font-weight: bold; color: white; background-color: #007aff; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #toggle-btn.active { background-color: #ff3b30; }

        /* --- è¨­å®šé¸å–®å…ƒä»¶ --- */
        .input-group { text-align: left; width: 100%; }
        .input-group label { display: block; color: #bbb; font-size: 0.95rem; margin-bottom: 8px; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #555; background: #333; color: #fff; box-sizing: border-box; }
        .file-upload { position: relative; overflow: hidden; display: block; width: 100%; }
        .file-upload input[type="file"] { position: absolute; top: 0; right: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-btn { background-color: #333; color: #ddd; padding: 12px; border-radius: 8px; display: block; text-align: center; border: 1px dashed #777; font-size: 0.9rem; }
        .drawer-btn { width: 100%; padding: 12px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; color: white; margin-top: 10px; font-weight: bold; margin-bottom: 10px; }
        #test-file-btn { background-color: #ff9800; }
        #test-tts-btn { background-color: #28a745; }
        #pip-btn { background-color: #9c27b0; }
        #history-btn { background-color: #007aff; }
        #osm-report-btn { background-color: #e91e63; }
        #status { margin-top: auto; padding-bottom: 10px; font-size: 0.8rem; color: #666; text-align: center; }
        #pip-canvas { display: none; }
        #pip-video { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; }

        @media (orientation: landscape) {
            .main-container { padding: 10px 40px; padding-top: 60px; justify-content: flex-end; }
            .dashboard { flex-direction: row; align-items: center; justify-content: center; gap: 50px; margin-bottom: 15px; }
            #speed-display { font-size: 40vh; text-align: center; line-height: 0.9; }
            .info-area { margin-top: 0; flex-direction: row; }
            .limit-sign { width: 130px; height: 130px; font-size: 60px; border-width: 12px; }
            .limit-sign.unknown { font-size: 80px; }
            .primary-controls { max-width: 850px; width: 95%; flex-direction: row; align-items: stretch; padding: 10px 20px; background: #1c1c1e; gap: 15px; }
            .control-group-left { flex: 2; justify-content: space-between; gap: 6px; }
            #toggle-btn { flex: 1; font-size: 1.4rem; height: auto; }
            .preset-btn { padding: 8px 0; font-size: 0.9rem; }
            .adjust-row { height: 40px; }
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

    <button id="menu-btn" onclick="toggleMenu()">â˜°</button>
    <div id="location-display">ğŸ“ å®šä½ä¸­...</div> 
    <div id="clock">--:--</div>

    <canvas id="pip-canvas" width="512" height="512"></canvas>
    <video id="pip-video" muted playsinline></video>
    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="settings-drawer">
        <div class="drawer-header">
            <span class="drawer-title">é€²éšè¨­å®š</span>
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
        </div>
        <div class="input-group">
            <label>è³‡æ–™ç®¡ç†</label>
            <button class="drawer-btn" id="history-btn" onclick="showHistory()">ğŸ“Š æŸ¥çœ‹è¡Œè»Šç´€éŒ„</button>
            <button class="drawer-btn" id="osm-report-btn" onclick="showOsmReports()">ğŸ“ æŸ¥çœ‹ç¼ºæ¼å›å ±</button>
        </div>
        <div class="input-group">
            <label>OSM è‡ªå‹•é€Ÿé™</label>
            <div style="display: flex; flex-direction: column; gap: 10px; background: #333; padding: 10px; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="auto-limit-check" checked style="width: 20px; height: 20px; accent-color: #2979ff;"> 
                    <span style="font-size: 1rem; color: #fff;">å•Ÿç”¨è‡ªå‹•åµæ¸¬</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; border-top: 1px solid #555; padding-top: 10px;">
                    <input type="checkbox" id="auto-log-check" style="width: 20px; height: 20px; accent-color: #ff3b30;"> 
                    <span style="font-size: 1rem; color: #ff9800;">ğŸŸ¥ è‡ªå‹•ç´€éŒ„ç¼ºæ¼</span>
                </div>
            </div>
        </div>
        <div class="input-group">
            <label>åš´é‡è¶…é€ŸèªéŸ³ (TTS)</label>
            <input type="text" id="voice-text" value="åš´é‡è¶…é€Ÿï¼è«‹ç…è»Š">
            <button class="drawer-btn" id="test-tts-btn">ğŸ—£ï¸ æ¸¬è©¦èªéŸ³</button>
        </div>
        <div id="status">æº–å‚™å°±ç·’</div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="history-header">
                <span id="modal-title">è¡Œè»Šç´€éŒ„</span>
                <button class="close-btn" onclick="closeHistory()" style="color:#fff;font-size:1.5rem;">Ã—</button>
            </div>
            <div class="history-list" id="history-list"></div>
        </div>
    </div>

    <div id="map-modal" class="modal-overlay">
        <div class="modal-container" style="height: 90%; max-width: 800px;">
            <div id="map-container">
                <button class="back-btn" onclick="closeMap()">â¬…ï¸ è¿”å›åˆ—è¡¨</button>
                <div id="trip-map"></div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="dashboard">
            <div id="speed-display">0</div> 
            <div class="info-area">
                <div class="limit-container">
                    <div id="visual-limit" class="limit-sign unknown">?</div>
                    <button id="report-btn" onclick="quickMarkMissing()">ğŸ“ æ¨™è¨˜ç¼ºæ¼</button>
                </div>
                <div class="threshold-info">
                    <div class="threshold-badge">æ‰£ç‰Œ: <span id="alarm-threshold-text">88</span></div>
                    <span id="limit-source-text" class="limit-source">ç­‰å¾… GPS...</span>
                </div>
            </div>
        </div>
        <div class="primary-controls">
            <div class="control-group-left">
                <div class="quick-presets">
                    <button class="preset-btn" onclick="setLimit(30)">30</button>
                    <button class="preset-btn" onclick="setLimit(40)">40</button>
                    <button class="preset-btn" onclick="setLimit(50)">50</button>
                </div>
                <div class="adjust-row">
                    <button class="adjust-btn" id="btn-minus">-10</button> 
                    <input type="number" id="limit-input" value="50">
                    <button class="adjust-btn" id="btn-plus">+10</button> 
                </div>
            </div>
            <button id="toggle-btn">ğŸš€ å•Ÿå‹•åµæ¸¬</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const speedDisplay = document.getElementById('speed-display');
        const locationDisplay = document.getElementById('location-display');
        const limitInput = document.getElementById('limit-input');
        const visualLimit = document.getElementById('visual-limit');
        const limitSourceText = document.getElementById('limit-source-text');
        const alarmThresholdText = document.getElementById('alarm-threshold-text');
        const reportBtn = document.getElementById('report-btn');
        
        const voiceTextInput = document.getElementById('voice-text');
        const toggleBtn = document.getElementById('toggle-btn');
        const testTtsBtn = document.getElementById('test-tts-btn');
        const btnMinus = document.getElementById('btn-minus');
        const btnPlus = document.getElementById('btn-plus');
        const clockEl = document.getElementById('clock');
        const statusDiv = document.getElementById('status');
        const autoLimitCheck = document.getElementById('auto-limit-check');
        const autoLogCheck = document.getElementById('auto-log-check'); // æ–°å¢
        const drawer = document.getElementById('settings-drawer');
        const overlay = document.getElementById('overlay');
        const body = document.body;

        const historyModal = document.getElementById('history-modal');
        const historyListEl = document.getElementById('history-list');
        const modalTitle = document.getElementById('modal-title');
        const mapModal = document.getElementById('map-modal');
        const pipCanvas = document.getElementById('pip-canvas');
        const pipCtx = pipCanvas.getContext('2d');
        const pipVideo = document.getElementById('pip-video');

        let watchId = null;
        let wakeLock = null;
        let lastSpeakTime = 0;
        let lastBeepTime = 0; 
        let isMonitoring = false; 
        let lastOsmCheckTime = 0;
        let lastAddressCheckTime = 0; 
        
        let isFirstFix = true;

        // Trip vars
        let tripStartTime = null;
        let tripMaxSpeed = 0;
        let tripDistance = 0; 
        let currentTripPath = []; 
        let lastLat = null;
        let lastLon = null;
        let mapInstance = null;
        let polylineLayer = null;

        const TOLERANCE = 38; 
        const PRE_WARNING_BUFFER = 5; 
        const synth = window.speechSynthesis;

        // --- æ™‚é˜ ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            clockEl.textContent = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock(); 

        // --- éŸ³æ•ˆ ---
        const silentAudio = new Audio();
        silentAudio.src = "data:audio/mp3;base64,SUQzBAAAAAABAFRYWFQAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhUAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhUAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==";
        silentAudio.loop = true; silentAudio.volume = 0.01; 

        let beepAudio = new Audio('./sound.mp3');
        function playCustomSound() {
            beepAudio.currentTime = 0;
            beepAudio.play().catch(e => console.log("Sound error", e));
        }

        testTtsBtn.addEventListener('click', () => {
            playCustomSound();
            setTimeout(() => { speak(voiceTextInput.value || "æ¸¬è©¦èªéŸ³"); }, 1000);
        });

        // --- UI æ“ä½œ ---
        window.toggleMenu = function() {
            drawer.classList.toggle('open');
            if (drawer.classList.contains('open')) overlay.style.display = 'block';
            else overlay.style.display = 'none';
        };

        // --- ç¼ºæ¼å›å ±ç³»çµ± (ä¸€éµæ¨™è¨˜ + è‡ªå‹•ç´€éŒ„) ---
        let currentMissingLat = null;
        let currentMissingLon = null;

        // æ‰‹å‹•å¿«é€Ÿæ¨™è¨˜
        window.quickMarkMissing = function() {
            if (!currentMissingLat || !currentMissingLon) {
                alert("å°šæœªå®šä½ï¼Œç„¡æ³•æ¨™è¨˜");
                return;
            }
            saveCustomLimit(currentMissingLat, currentMissingLon, null);
            
            reportBtn.textContent = "âœ… å·²æ¨™è¨˜";
            reportBtn.style.background = "#4caf50";
            setTimeout(() => {
                reportBtn.textContent = "ğŸ“ æ¨™è¨˜ç¼ºæ¼";
                reportBtn.style.background = "#ff9800";
                reportBtn.style.display = 'none'; 
            }, 2000);
            
            statusDiv.textContent = "å·²æ¨™è¨˜æ­¤è™•ï¼Œè«‹ç¨å¾Œè£œå¡«é€Ÿé™";
        };

        function saveCustomLimit(lat, lon, limit) {
            let reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            // æª¢æŸ¥é‡è¤‡ (æ¥µè¿‘è·é›¢ä¸é‡è¤‡å­˜)
            const exists = reports.find(r => Math.abs(r.lat - lat) < 0.0001 && Math.abs(r.lon - lon) < 0.0001);
            if (exists) {
                if(limit !== null) exists.limit = limit; 
                return;
            }

            const newReport = {
                lat: lat,
                lon: lon,
                limit: limit, 
                date: new Date().toLocaleString('zh-TW'),
                address: locationDisplay.textContent.replace('ğŸ“ ', '')
            };
            reports.push(newReport);
            // é™åˆ¶æ•¸é‡é¿å… LocalStorage çˆ†ç‚¸ (æœ€å¤š100ç­†)
            if (reports.length > 100) reports.shift();
            localStorage.setItem('osm_reports', JSON.stringify(reports));
        }

        function findCustomLimit(lat, lon) {
            const reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            for (let r of reports) {
                if (Math.abs(r.lat - lat) < 0.0005 && Math.abs(r.lon - lon) < 0.0005) {
                    return r.limit; 
                }
            }
            return undefined; 
        }

        window.updateReportSpeed = function(index, speed) {
            let reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            reports[index].limit = speed;
            localStorage.setItem('osm_reports', JSON.stringify(reports));
            showOsmReports(); 
        };

        window.showOsmReports = function() {
            toggleMenu();
            const reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            modalTitle.textContent = "ç¼ºæ¼æ¨™è¨˜åˆ—è¡¨";
            historyListEl.innerHTML = "";
            
            if (reports.length === 0) {
                historyListEl.innerHTML = `<div class="empty-msg">å°šç„¡æ¨™è¨˜ç´€éŒ„</div>`;
            } else {
                reports.forEach((r, idx) => {
                    const editLink = `https://www.openstreetmap.org/edit?editor=id#map=19/${r.lat}/${r.lon}`;
                    const isPending = (r.limit === null);
                    
                    let speedControls = '';
                    if (isPending) {
                        speedControls = `
                            <div style="margin-top:5px;">
                                <span style="color:#ff9800; font-size:0.9rem;">å¿«é€Ÿè¨­å®š: </span>
                                <button class="btn-set-speed" onclick="updateReportSpeed(${idx}, 30)">30</button>
                                <button class="btn-set-speed" onclick="updateReportSpeed(${idx}, 40)">40</button>
                                <button class="btn-set-speed" onclick="updateReportSpeed(${idx}, 50)">50</button>
                                <button class="btn-set-speed" onclick="updateReportSpeed(${idx}, 60)">60</button>
                            </div>
                        `;
                    } else {
                        speedControls = `<span style="color:#0f0">å·²è¨­å®š: ${r.limit} km/h</span>`;
                    }

                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="h-date">${r.date}</div>
                        <div style="font-size:1.1rem; font-weight:bold;">${r.address || "æœªçŸ¥è·¯æ®µ"}</div>
                        <div class="h-stats">
                            ${speedControls}
                        </div>
                        <div style="margin-top:8px; border-top:1px solid #444; padding-top:5px;">
                            <a href="${editLink}" target="_blank" class="btn-link">ğŸŒ OSM</a>
                            <button class="btn-link" style="background:#d32f2f; margin-left:10px;" onclick="deleteReport(${idx})">åˆªé™¤</button>
                        </div>
                    `;
                    historyListEl.appendChild(item);
                });
            }
            historyModal.classList.add('show');
        }

        window.deleteReport = function(index) {
            let reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            reports.splice(index, 1);
            localStorage.setItem('osm_reports', JSON.stringify(reports));
            showOsmReports(); 
        }

        // --- æ­·å²ç´€éŒ„ ---
        window.showHistory = function() {
            toggleMenu(); 
            renderHistory();
            historyModal.classList.add('show');
        };
        window.closeHistory = function() { historyModal.classList.remove('show'); };
        window.clearHistory = function() {
            if(confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ')) {
                localStorage.removeItem('trip_records');
                renderHistory();
            }
        };

        window.showMap = function(index) {
            const records = JSON.parse(localStorage.getItem('trip_records') || "[]");
            const record = records[index];
            if(!record || !record.path || record.path.length === 0) { alert("ç„¡è»Œè·¡è³‡æ–™"); return; }
            mapModal.classList.add('show');
            if (!mapInstance) {
                mapInstance = L.map('trip-map');
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 19
                }).addTo(mapInstance);
            }
            if (polylineLayer) mapInstance.removeLayer(polylineLayer);
            setTimeout(() => {
                mapInstance.invalidateSize();
                polylineLayer = L.polyline(record.path, { color: '#0f0', weight: 4, opacity: 0.8 }).addTo(mapInstance);
                mapInstance.fitBounds(polylineLayer.getBounds(), { padding: [50, 50] });
            }, 100);
        };
        window.closeMap = function() { mapModal.classList.remove('show'); };

        function saveTrip() {
            if (!tripStartTime) return;
            const now = new Date();
            const durationMs = now - tripStartTime;
            if (durationMs < 10000 && tripDistance < 0.1) return; 

            const hours = durationMs / 1000 / 3600;
            const avgSpeed = hours > 0 ? (tripDistance / hours) : 0;
            const record = {
                date: tripStartTime.toLocaleString('zh-TW'),
                duration: (durationMs / 1000 / 60).toFixed(1) + " åˆ†",
                distance: tripDistance.toFixed(1) + " km",
                maxSpeed: Math.round(tripMaxSpeed) + " km/h",
                avgSpeed: Math.round(avgSpeed) + " km/h",
                path: currentTripPath
            };
            let records = JSON.parse(localStorage.getItem('trip_records') || "[]");
            records.unshift(record); if (records.length > 20) records.pop();
            localStorage.setItem('trip_records', JSON.stringify(records));
            alert(`ğŸ è¡Œç¨‹çµæŸ\né‡Œç¨‹: ${record.distance}\næ™‚é–“: ${record.duration}`);
        }

        function renderHistory() {
            modalTitle.textContent = "è¡Œè»Šç´€éŒ„";
            const records = JSON.parse(localStorage.getItem('trip_records') || "[]");
            historyListEl.innerHTML = "";
            if (records.length === 0) {
                historyListEl.innerHTML = `<div class="empty-msg">å°šç„¡ç´€éŒ„</div>`;
                return;
            }
            records.forEach((r, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="h-date">${r.date} - ${r.duration}</div>
                    <div class="h-stats">
                        <div class="h-stat-box"><span class="h-label">æ¥µé€Ÿ</span><span class="h-val max">${r.maxSpeed}</span></div>
                        <div class="h-stat-box"><span class="h-label">å¹³å‡</span><span class="h-val">${r.avgSpeed}</span></div>
                        <div class="h-stat-box"><span class="h-label">é‡Œç¨‹</span><span class="h-val">${r.distance}</span></div>
                    </div>
                    <button class="btn-link" style="margin-top:5px;background:#007aff;" onclick="showMap(${index})">ğŸ—ºï¸ æŸ¥çœ‹åœ°åœ–</button>
                `;
                historyListEl.appendChild(item);
            });
        }

        // --- ä¸»è¦é‚è¼¯ ---
        window.setLimit = function(val) {
            limitInput.value = val;
            updateVisualSign(val, false);
            updateThresholdDisplay();
            updatePiP(0, val);
        };
        btnMinus.addEventListener('click', () => setLimit(Math.max(0, (parseInt(limitInput.value)||0) - 10)));
        btnPlus.addEventListener('click', () => setLimit((parseInt(limitInput.value)||0) + 10));

        toggleBtn.addEventListener('click', () => {
            silentAudio.play().catch(()=>{}); 
            if (!isMonitoring) startActiveMonitoring();
            else stopActiveMonitoring();
        });

        limitInput.addEventListener('input', () => {
            updateVisualSign(limitInput.value, false);
            updateThresholdDisplay();
            updatePiP(0, limitInput.value);
        });

        function updateThresholdDisplay() {
            const base = parseInt(limitInput.value) || 0;
            alarmThresholdText.textContent = base + TOLERANCE;
        }

        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock(); });

        function initGPS() {
            if (navigator.geolocation) {
                statusDiv.textContent = "å®šä½ä¸­...";
                locationDisplay.textContent = "å®šä½ä¸­...";
                watchId = navigator.geolocation.watchPosition(updatePosition, handleError, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            } else { alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS"); }
        }
        initGPS();

        async function startActiveMonitoring() {
            silentAudio.play().catch(()=>{}); playCustomSound();
            setTimeout(() => { speak("åµæ¸¬é–‹å§‹"); }, 800);
            await requestWakeLock();
            tripStartTime = new Date(); tripMaxSpeed = 0; tripDistance = 0;
            currentTripPath = []; lastLat = null; lastLon = null;
            isMonitoring = true; 
            toggleBtn.textContent = "ğŸ›‘ åœæ­¢åµæ¸¬"; toggleBtn.classList.add('active');
            statusDiv.textContent = "âš ï¸ ç›£æ§ä¸­";
        }

        function stopActiveMonitoring() {
            if (wakeLock !== null) wakeLock.release();
            silentAudio.pause(); saveTrip();
            isMonitoring = false; 
            toggleBtn.textContent = "ğŸš€ å•Ÿå‹•åµæ¸¬"; toggleBtn.classList.remove('active');
            body.classList.remove('danger'); body.classList.remove('warning');
            statusDiv.textContent = "å·²æš«åœ";
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = (lat2-lat1)*(Math.PI/180); const dLon = (lon2-lon1)*(Math.PI/180);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function updatePosition(position) {
            const lat = position.coords.latitude; const lon = position.coords.longitude;
            let speedMps = position.coords.speed; if (speedMps === null || speedMps < 0) speedMps = 0;
            const speedKmh = speedMps * 3.6;

            currentMissingLat = lat; currentMissingLon = lon;

            if (isMonitoring) {
                if (lastLat !== null) {
                    const dist = getDistanceFromLatLonInKm(lastLat, lastLon, lat, lon);
                    if (speedKmh > 2 && dist > 0.0005 && dist < 0.2) tripDistance += dist;
                    if (dist > 0.01) currentTripPath.push([lat, lon]);
                } else currentTripPath.push([lat, lon]);
                if (speedKmh > tripMaxSpeed) tripMaxSpeed = speedKmh;
                lastLat = lat; lastLon = lon;
            }

            speedDisplay.innerHTML = `${Math.round(speedKmh)}`;
            const now = Date.now();
            
            // OSM & åœ°å€æ›´æ–°
            if (autoLimitCheck.checked && ( (now - lastOsmCheckTime > 15000 && speedKmh > 10) || isFirstFix ) ) {
                const savedLimit = findCustomLimit(lat, lon);
                if (savedLimit !== undefined) {
                    if (savedLimit !== null) {
                        limitInput.value = savedLimit;
                        updateVisualSign(savedLimit, false, true); 
                        updateThresholdDisplay();
                    } else {
                         updateVisualSign(null, true);
                    }
                } else {
                    fetchSpeedLimit(lat, lon);
                }
                lastOsmCheckTime = now;
                isFirstFix = false; 
            }

            if (now - lastAddressCheckTime > 15000) { fetchAddress(lat, lon); lastAddressCheckTime = now; }
            
            checkOverSpeed(speedKmh);
            updatePiP(speedKmh, limitInput.value);
        }

        function checkOverSpeed(currentSpeed) {
            if (!isMonitoring) { body.classList.remove('danger', 'warning'); return; }
            const baseLimit = parseFloat(limitInput.value);
            const alarmTrigger = baseLimit + TOLERANCE; 
            const preWarningStart = alarmTrigger - PRE_WARNING_BUFFER; 
            const now = Date.now();
            if (currentSpeed > alarmTrigger) {
                body.classList.remove('warning'); body.classList.add('danger');
                if (now - lastSpeakTime > 3000) { playCustomSound(); setTimeout(() => speak(voiceTextInput.value), 1000); lastSpeakTime = now; }
            } else if (currentSpeed > preWarningStart) {
                body.classList.remove('danger'); body.classList.add('warning');
                if (now - lastBeepTime > 1000) { playCustomSound(); lastBeepTime = now; }
            } else { body.classList.remove('danger', 'warning'); }
        }

        async function fetchAddress(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=zh-TW`;
            try {
                const response = await fetch(url); const data = await response.json();
                if (data && data.address) {
                    const road = data.address.road || ""; const suburb = data.address.suburb || data.address.city_district || ""; const city = data.address.city || "";
                    locationDisplay.textContent = road ? `${suburb} ${road}` : `${city} ${suburb}`;
                }
            } catch (err) {}
        }

        async function fetchSpeedLimit(lat, lon) {
            const query = `[out:json];way[maxspeed](around:20,${lat},${lon});out tags;`;
            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await response.json();
                if (data.elements && data.elements.length > 0) {
                    let maxspeed = data.elements[0].tags.maxspeed;
                    let limitNumber = parseInt(maxspeed);
                    if (!isNaN(limitNumber)) {
                        limitInput.value = limitNumber; 
                        updateVisualSign(limitNumber, true);
                        updateThresholdDisplay();
                        updatePiP(0, limitNumber);
                    } else {
                        setDefaultLimit(lat, lon); // Pass coords
                    }
                } else {
                    setDefaultLimit(lat, lon); // Pass coords
                }
            } catch (err) { setDefaultLimit(lat, lon); }
        }

        function setDefaultLimit(lat, lon) {
            const defaultVal = 50;
            limitInput.value = defaultVal;
            updateVisualSign(defaultVal, true, false, true); 
            updateThresholdDisplay();
            updatePiP(0, defaultVal);

            // [New] è‡ªå‹•ç´€éŒ„é‚è¼¯
            if (autoLogCheck.checked && lat && lon) {
                 saveCustomLimit(lat, lon, null); // å­˜å…¥ null å¾…å¡«
            }
        }

        function updateVisualSign(val, isAuto, isCustom = false, isDefault = false) {
            if (val && val > 0) {
                visualLimit.textContent = val;
                visualLimit.classList.remove('unknown');
                
                if (isDefault) {
                    limitSourceText.innerHTML = "âš ï¸ é è¨­ (ç„¡è³‡)";
                    limitSourceText.style.color = "#ff9800";
                    reportBtn.style.display = 'block'; 
                } else {
                    reportBtn.style.display = 'none'; 
                    if (isCustom) {
                        limitSourceText.innerHTML = "ğŸ“ æœ¬åœ°è¨˜æ†¶";
                        limitSourceText.style.color = "#ff9800";
                    } else {
                        limitSourceText.innerHTML = isAuto ? "OSM è‡ªå‹•" : "æ‰‹å‹•è¨­å®š";
                        limitSourceText.style.color = isAuto ? "#4caf50" : "#aaa";
                    }
                }
            } else {
                visualLimit.textContent = "?";
                visualLimit.classList.add('unknown');
                limitSourceText.innerHTML = "âš ï¸ ç„¡é€Ÿé™è³‡æ–™";
                limitSourceText.style.color = "#ff3b30";
                reportBtn.style.display = 'block';
            }
        }

        function speak(text) {
            if (synth.speaking) return;
            const u = new SpeechSynthesisUtterance(text); u.lang = 'zh-TW'; u.rate = 1.1; 
            synth.speak(u);
        }
        function handleError(error) { statusDiv.textContent = "âŒ GPS è¨Šè™Ÿéºå¤±"; locationDisplay.textContent = "GPS éºå¤±"; }
        
        // PiP Logic
        function updatePiP(currentSpeed, limit) {
            pipCtx.fillStyle = '#000000'; pipCtx.fillRect(0, 0, 512, 512);
            const baseLimit = parseInt(limit) || 0;
            let bgColor = '#000000';
            if (isMonitoring) {
                if (currentSpeed > baseLimit + TOLERANCE) bgColor = '#b71c1c'; 
                else if (currentSpeed > baseLimit + TOLERANCE - PRE_WARNING_BUFFER) bgColor = '#fbc02d'; 
            }
            if (bgColor !== '#000000') { pipCtx.fillStyle = bgColor; pipCtx.fillRect(0, 0, 512, 512); }
            pipCtx.fillStyle = (bgColor === '#b71c1c') ? '#fff' : (bgColor === '#fbc02d' ? '#000' : '#0f0');
            pipCtx.font = 'bold 250px Arial'; pipCtx.textAlign = 'center'; pipCtx.textBaseline = 'middle';
            pipCtx.fillText(Math.round(currentSpeed), 256, 200);
            pipCtx.beginPath(); pipCtx.arc(256, 400, 70, 0, 2 * Math.PI); pipCtx.fillStyle = '#fff'; pipCtx.fill();
            pipCtx.lineWidth = 10; pipCtx.strokeStyle = '#cc0000'; pipCtx.stroke();
            pipCtx.fillStyle = '#000'; pipCtx.font = 'bold 60px Arial'; pipCtx.fillText(baseLimit, 256, 403);
        }
    </script>
</body>
</html>