<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜²æ‰£ç‰Œé è­¦ç³»çµ±</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            margin: 0;
            overflow-y: auto; overflow-x: hidden;
            min-height: 100vh; min-height: 100dvh; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            touch-action: manipulation;
            transition: background-color 0.1s;
        }

        /* åš´é‡è¶…é€Ÿï¼šç´…è‰²é–ƒçˆ */
        body.danger {
            background-color: #b71c1c;
            animation: flash-red 0.5s infinite alternate;
        }
        @keyframes flash-red { from { background-color: #b71c1c; } to { background-color: #ff0000; } }

        /* é è­¦æ¨¡å¼ï¼šé»ƒè‰²é–ƒçˆ */
        body.warning {
            background-color: #fbc02d;
            animation: flash-yellow 0.8s infinite alternate;
        }
        body.warning #speed-display { color: #000; text-shadow: none; }
        body.warning .text-info { color: #333; }
        @keyframes flash-yellow { from { background-color: #fbc02d; } to { background-color: #ffeb3b; } }

        /* --- ä»‹é¢ --- */
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 95%; height: auto; flex-grow: 1; padding: 20px 0; }
        .dashboard { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; margin-bottom: 20px; }
        
        #speed-display {
            font-weight: bold; line-height: 1;
            text-shadow: 0 0 10px rgba(0,255,0,0.5);
            color: #0f0;
            font-size: 15vh;
            transition: color 0.2s; margin-bottom: 10px;
        }
        body.danger #speed-display { color: #fff; text-shadow: none; }
        .unit { font-size: 0.3em; color: #aaa; }

        .info-area { display: flex; align-items: center; gap: 15px; }
        .limit-sign {
            width: 100px; height: 100px; background-color: #fff;
            border: 8px solid #cc0000; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #000; font-weight: bold; font-size: 40px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); flex-shrink: 0;
        }
        .limit-sign.unknown { border-color: #777; color: #777; }
        .text-info { text-align: left; font-size: 0.9rem; color: #ccc; display: flex; flex-direction: column; gap: 5px; }
        
        .threshold-badge { color: #ffeb3b; border: 1px solid #555; padding: 2px 8px; border-radius: 10px; background: rgba(0,0,0,0.5); display: inline-block; }
        body.warning .threshold-badge { color: #000; border-color: #333; }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .controls {
            width: 100%; max-width: 400px;
            background: rgba(30, 30, 30, 0.8);
            padding: 20px; border-radius: 15px; text-align: center;
            margin-bottom: 30px; transition: opacity 0.3s;
        }
        .controls.monitoring { opacity: 0.3; }
        .controls.monitoring:hover { opacity: 1; }

        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; color: #aaa; font-size: 0.8rem; margin-bottom: 5px; }

        input[type="number"], input[type="text"] { 
            width: 100%; padding: 12px; font-size: 1.1rem; 
            border-radius: 8px; border: none; text-align: center; box-sizing: border-box;
        }
        
        /* æª”æ¡ˆä¸Šå‚³æŒ‰éˆ•ç¾åŒ– */
        .file-upload { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-upload input[type="file"] {
            position: absolute; top: 0; right: 0; margin: 0; padding: 0;
            font-size: 20px; cursor: pointer; opacity: 0; filter: alpha(opacity=0);
            width: 100%; height: 100%;
        }
        .file-btn {
            background-color: #555; color: white; padding: 10px;
            border-radius: 8px; display: block; width: 100%;
            box-sizing: border-box; border: 1px dashed #999;
        }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 15px; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; flex: 1; -webkit-appearance: none; }
        #test-file-btn { background-color: #ff9800; } 
        #test-tts-btn { background-color: #28a745; } 
        #toggle-btn { background-color: #2979ff; }
        #toggle-btn.active { background-color: #d32f2f; }
        #status { margin-top: 10px; font-size: 0.8rem; color: #888; }

        @media (orientation: landscape) {
            body { overflow-y: auto; justify-content: center; }
            .container { flex-direction: row; gap: 30px; padding: 10px; height: 100%; }
            .dashboard { flex: 2; flex-direction: row; justify-content: center; gap: 40px; margin-bottom: 0; }
            #speed-display { font-size: 35vh; order: 1; margin-bottom: 0; }
            .info-area { flex-direction: column; order: 2; align-items: center; }
            .limit-sign { width: 18vh; height: 18vh; font-size: 7vh; border-width: 1.2vh; }
            .controls { flex: 1; max-width: 320px; margin-bottom: 0; display: flex; flex-direction: column; justify-content: center; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="dashboard">
            <div id="speed-display">0<span class="unit"></span></div>
            <div class="info-area">
                <div id="visual-limit" class="limit-sign unknown">--</div>
                <div class="text-info">
                    <span id="limit-source-text" style="color:#aaa; font-size: 0.8em;">GPS å¾…å‘½</span>
                    <div class="threshold-badge">
                        æ‰£ç‰Œé–€æª»: <span id="alarm-threshold-text">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls" id="controls-panel">
            <div class="input-group">
                <label>ç›®å‰é€Ÿé™ (km/h)</label>
                <input type="number" id="limit-input" value="50">
            </div>
            
            <div class="input-group">
                <label>åš´é‡è¶…é€ŸèªéŸ³ (TTS)</label>
                <input type="text" id="voice-text" value="åš´é‡è¶…é€Ÿï¼è«‹ç…è»Š">
            </div>

            <div class="input-group">
                <label>è­¦ç¤ºéŸ³æ•ˆ (é è¨­ sound.mp3)</label>
                <div class="file-upload">
                    <div class="file-btn" id="file-label">ğŸ“‚ é¸æ“‡éŸ³æ•ˆ (é è¨­: sound.mp3)</div>
                    <input type="file" id="sound-upload" accept="audio/*">
                </div>
            </div>

            <div style="font-size: 0.9rem; text-align: left; margin-bottom: 10px;">
                <input type="checkbox" id="auto-limit-check" checked style="width: auto; flex: none;"> 
                <label for="auto-limit-check">OSM è‡ªå‹•é€Ÿé™</label>
            </div>
            
            <div class="btn-group">
                <button id="test-file-btn">ğŸ”Š éŸ³æ•ˆ</button>
                <button id="test-tts-btn">ğŸ—£ï¸ èªéŸ³</button>
            </div>
            <div class="btn-group">
                <button id="toggle-btn">ğŸš€ å•Ÿå‹•ç›£æ§</button>
            </div>
            
            <div id="status">æº–å‚™å°±ç·’</div>
        </div>
    </div>

    <script>
        const speedDisplay = document.getElementById('speed-display');
        const limitInput = document.getElementById('limit-input');
        const visualLimit = document.getElementById('visual-limit');
        const limitSourceText = document.getElementById('limit-source-text');
        const alarmThresholdText = document.getElementById('alarm-threshold-text');
        
        const voiceTextInput = document.getElementById('voice-text');
        const soundUpload = document.getElementById('sound-upload');
        const fileLabel = document.getElementById('file-label');

        const toggleBtn = document.getElementById('toggle-btn');
        const testFileBtn = document.getElementById('test-file-btn');
        const testTtsBtn = document.getElementById('test-tts-btn');
        const statusDiv = document.getElementById('status');
        const autoLimitCheck = document.getElementById('auto-limit-check');
        const controlsPanel = document.getElementById('controls-panel');
        const body = document.body;

        let watchId = null;
        let wakeLock = null;
        let lastSpeakTime = 0;
        let lastBeepTime = 0; 
        let isMonitoring = false;
        let lastOsmCheckTime = 0;
        
        const TOLERANCE = 38; 
        const PRE_WARNING_BUFFER = 5; 
        
        const synth = window.speechSynthesis;

        // 1. ç„¡è²èƒŒæ™¯ (CarPlay Keep Alive)
        const silentAudio = new Audio();
        silentAudio.src = "data:audio/mp3;base64,SUQzBAAAAAABAFRYWFQAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhUAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhUAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==";
        silentAudio.loop = true;
        silentAudio.volume = 0.01; 

        // 2. è­¦å ±éŸ³æ•ˆ
        let beepAudio = new Audio();
        const DEFAULT_SOUND_PATH = './sound.mp3';

        function makeDefaultBeep() {
            const sampleRate = 44100;
            const duration = 0.5; 
            const numSamples = duration * sampleRate;
            const buffer = new Uint8Array(44 + numSamples);
            const view = new DataView(buffer.buffer);
            const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + numSamples, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate, true); view.setUint16(32, 1, true); view.setUint16(34, 8, true); writeString(view, 36, 'data'); view.setUint32(40, numSamples, true);
            const frequency = 880; 
            for (let i = 0; i < numSamples; i++) {
                const t = i / sampleRate;
                const sample = (Math.sin(2 * Math.PI * frequency * t) > 0 ? 200 : 55); 
                view.setUint8(44 + i, sample);
            }
            return URL.createObjectURL(new Blob([buffer], { type: 'audio/wav' }));
        }

        function initSound() {
            beepAudio.src = DEFAULT_SOUND_PATH;
            beepAudio.onerror = function() {
                console.log("åˆ‡æ›ç‚ºé è¨­é›»å­éŸ³");
                fileLabel.textContent = "âš ï¸ ç„¡ sound.mp3 (ç”¨é è¨­éŸ³)";
                beepAudio.src = makeDefaultBeep();
            };
            beepAudio.oncanplaythrough = function() {
                fileLabel.textContent = "âœ… å·²è¼‰å…¥ sound.mp3";
                fileLabel.style.borderColor = "#28a745";
            };
        }
        initSound();

        updateThresholdDisplay();

        // æª”æ¡ˆä¸Šå‚³
        soundUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const objectUrl = URL.createObjectURL(file);
                beepAudio.src = objectUrl;
                beepAudio.onerror = null; 
                fileLabel.textContent = `ğŸ“‚ ä½¿ç”¨: ${file.name}`;
                fileLabel.style.backgroundColor = "#28a745";
                playCustomSound();
            }
        });

        function playCustomSound() {
            beepAudio.currentTime = 0;
            beepAudio.play().catch(e => console.log("Sound error", e));
        }

        // --- æŒ‰éˆ• ---
        testFileBtn.addEventListener('click', () => {
            silentAudio.play().catch(()=>{}); 
            playCustomSound();
            statusDiv.textContent = "ğŸ”Š æ’­æ”¾è­¦ç¤ºéŸ³...";
            setTimeout(() => statusDiv.textContent = "æº–å‚™å°±ç·’", 1000);
        });

        testTtsBtn.addEventListener('click', () => {
            silentAudio.play().catch(()=>{});
            playCustomSound();
            setTimeout(() => { speak(voiceTextInput.value || "æ¸¬è©¦èªéŸ³"); }, 1000);
            statusDiv.textContent = "ğŸ—£ï¸ æ’­æ”¾èªéŸ³...";
            setTimeout(() => statusDiv.textContent = "æº–å‚™å°±ç·’", 2000);
        });

        toggleBtn.addEventListener('click', () => {
            silentAudio.play().catch(()=>{}); 
            if (!isMonitoring) startMonitoring();
            else stopMonitoring();
        });

        limitInput.addEventListener('input', () => {
            updateVisualSign(limitInput.value, false);
            updateThresholdDisplay();
        });

        function updateThresholdDisplay() {
            const base = parseInt(limitInput.value) || 0;
            alarmThresholdText.textContent = base + TOLERANCE;
        }

        async function requestWakeLock() {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') { await requestWakeLock(); }
        });

        async function startMonitoring() {
            // 1. ç¢ºä¿éŸ³è¨Šé€šé“é–‹å•Ÿ
            silentAudio.play().catch(()=>{});
            
            // 2. æ’­æ”¾ä¸€è²è­¦ç¤ºéŸ³ (å–šé†’ CarPlay)
            playCustomSound();
            
            // 3. å»¶é² 0.8ç§’å¾Œï¼ŒèªéŸ³æ’­å ±ã€Œåµæ¸¬é–‹å§‹ã€
            setTimeout(() => {
                speak("åµæ¸¬é–‹å§‹");
            }, 800);

            await requestWakeLock();

            if (navigator.geolocation) {
                statusDiv.textContent = "å®šä½ä¸­...";
                watchId = navigator.geolocation.watchPosition(updatePosition, handleError, {
                    enableHighAccuracy: true, timeout: 5000, maximumAge: 0
                });
                isMonitoring = true;
                toggleBtn.textContent = "åœæ­¢ç›£æ§";
                toggleBtn.classList.add('active');
                controlsPanel.classList.add('monitoring'); 
            } else {
                alert("ä¸æ”¯æ´ GPS");
            }
        }

        function stopMonitoring() {
            if (watchId !== null) navigator.geolocation.clearWatch(watchId);
            if (wakeLock !== null) wakeLock.release();
            silentAudio.pause();
            isMonitoring = false;
            toggleBtn.textContent = "å•Ÿå‹•ç›£æ§";
            toggleBtn.classList.remove('active');
            controlsPanel.classList.remove('monitoring');
            speedDisplay.innerHTML = `0<span class="unit"></span>`;
            body.classList.remove('danger');
            body.classList.remove('warning');
            statusDiv.textContent = "å·²æš«åœ";
        }

        function updatePosition(position) {
            let speedMps = position.coords.speed;
            if (speedMps === null || speedMps < 0) speedMps = 0;
            const speedKmh = speedMps * 3.6;

            speedDisplay.innerHTML = `${Math.round(speedKmh)}<span class="unit"></span>`;
            statusDiv.textContent = `GPS: Â±${Math.round(position.coords.accuracy)}m`;

            const now = Date.now();
            if (autoLimitCheck.checked && (now - lastOsmCheckTime > 15000) && speedKmh > 10) {
                fetchSpeedLimit(position.coords.latitude, position.coords.longitude);
                lastOsmCheckTime = now;
            }
            checkOverSpeed(speedKmh);
        }

        function checkOverSpeed(currentSpeed) {
            const baseLimit = parseFloat(limitInput.value);
            const alarmTrigger = baseLimit + TOLERANCE; 
            const preWarningStart = alarmTrigger - PRE_WARNING_BUFFER; 

            const now = Date.now();

            if (currentSpeed > alarmTrigger) {
                body.classList.remove('warning');
                body.classList.add('danger');
                if (now - lastSpeakTime > 3000) { 
                    playCustomSound(); 
                    setTimeout(() => speak(voiceTextInput.value), 1000);
                    lastSpeakTime = now;
                }
            } else if (currentSpeed > preWarningStart) {
                body.classList.remove('danger');
                body.classList.add('warning');
                if (now - lastBeepTime > 1000) {
                    playCustomSound(); 
                    lastBeepTime = now;
                }
            } else {
                body.classList.remove('danger');
                body.classList.remove('warning');
            }
        }

        async function fetchSpeedLimit(lat, lon) {
            limitSourceText.textContent = "æ›´æ–°ä¸­...";
            // åªæŸ¥è©¢é€Ÿé™ï¼Œç§»é™¤æ¸¬é€Ÿç…§ç›¸
            const query = `[out:json];way[maxspeed](around:20,${lat},${lon});out tags;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.elements && data.elements.length > 0) {
                    let maxspeed = data.elements[0].tags.maxspeed;
                    let limitNumber = parseInt(maxspeed);
                    if (maxspeed.includes("mph")) limitNumber = Math.round(limitNumber * 1.609);
                    if (!isNaN(limitNumber)) {
                        limitInput.value = limitNumber; 
                        updateVisualSign(limitNumber, true);
                        updateThresholdDisplay();
                    }
                } else {
                    limitSourceText.textContent = "ç„¡ OSM è³‡æ–™";
                    updateVisualSign(limitInput.value, false);
                }
            } catch (err) { limitSourceText.textContent = "é€£ç·šå¤±æ•—"; }
        }

        function updateVisualSign(val, isAuto) {
            if (val && val > 0) {
                visualLimit.textContent = val;
                visualLimit.classList.remove('unknown');
                limitSourceText.innerHTML = isAuto ? "OSM è‡ªå‹•" : "æ‰‹å‹•è¨­å®š";
                limitSourceText.style.color = isAuto ? "#4caf50" : "#aaa";
            } else {
                visualLimit.textContent = "--";
                visualLimit.classList.add('unknown');
            }
        }

        function speak(text) {
            if (synth.speaking) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.1; 
            const voices = synth.getVoices();
            const targetVoice = voices.find(v => v.name.includes("Google") && v.lang.includes("zh")) 
                             || voices.find(v => v.lang.includes("zh"));     
            if (targetVoice) utterance.voice = targetVoice;
            synth.speak(utterance);
        }

        function handleError(error) {
            console.warn(`GPS Error: ${error.message}`);
            statusDiv.textContent = "âŒ GPS è¨Šè™Ÿéºå¤±";
        }
        
        window.speechSynthesis.onvoiceschanged = () => {};
    </script>
</body>
</html>