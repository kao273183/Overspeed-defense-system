<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>防扣牌預警系統</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-512.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

    <button id="menu-btn" onclick="toggleMenu()">☰</button>
    <button id="minimap-btn" onclick="toggleMiniMap()">🗺️ 地圖</button>

    <div id="location-display">📍 定位中...</div>
    <div id="clock">--:--</div>

    <div class="extra-info">
        <span id="altitude-display">Alt: --m</span>
        <span id="heading-display">---</span>
    </div>

    <canvas id="pip-canvas" width="512" height="512"></canvas>
    <video id="pip-video" muted playsinline></video>
    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="settings-drawer">
        <div class="drawer-header">
            <span class="drawer-title">進階設定</span>
            <button class="close-btn" onclick="toggleMenu()">×</button>
        </div>

        <div class="ad-container">
            <span class="ad-label">贊助商廣告 (申請後顯示)</span>
        </div>

        <div class="input-group">
            <label>系統資訊</label>
            <button class="drawer-btn" id="help-btn" onclick="showHelp()">ℹ️ 使用說明 / 關於</button>
        </div>

        <div class="input-group">
            <label>顯示設定</label>
            <button class="drawer-btn" id="drawer-hud-btn" onclick="toggleHud()">🪞 切換 HUD 鏡像模式</button>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <button class="drawer-btn" style="background:#444;" onclick="setTheme('digital')">🔢 數位</button>
                <button class="drawer-btn" style="background:#444;" onclick="setTheme('analog')">⌚ 指針</button>
            </div>
            <label style="margin-top:10px; font-size:0.9rem; color:#888;">指針主題</label>
            <div id="gauge-theme-list" style="display:flex; flex-wrap:wrap; gap:8px;">
                <!-- Themes will be injected here -->
            </div>
        </div>

        <div class="input-group">
            <label>資料管理</label>
            <button class="drawer-btn" id="history-btn" onclick="showHistory()">📊 查看行車紀錄</button>
            <button class="drawer-btn" id="osm-report-btn" onclick="showOsmReports()">📝 查看缺漏回報</button>
            <button class="drawer-btn" id="upload-history-btn" onclick="showUploadHistory()">☁️ 查看上傳紀錄</button>
        </div>
        <div class="input-group">
            <label>OSM 自動速限</label>
            <div
                style="display: flex; flex-direction: column; gap: 10px; background: #333; padding: 10px; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="auto-limit-check" checked
                        style="width: 20px; height: 20px; accent-color: #2979ff;">
                    <span style="font-size: 1rem; color: #fff;">啟用自動偵測</span>
                </div>
                <div
                    style="display: flex; align-items: center; gap: 10px; border-top: 1px solid #555; padding-top: 10px;">
                    <input type="checkbox" id="auto-log-check"
                        style="width: 20px; height: 20px; accent-color: #ff3b30;">
                    <span style="font-size: 1rem; color: #ff9800;">🟥 自動紀錄缺漏</span>
                </div>
            </div>
        </div>
        <div class="input-group">
            <label>嚴重超速語音 (TTS)</label>
            <input type="text" id="voice-text" value="嚴重超速！請煞車">
            <button class="drawer-btn" id="test-tts-btn">🗣️ 測試語音</button>
        </div>
        <div id="status">準備就緒</div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="history-header">
                <span id="modal-title">行車紀錄</span>
                <button id="history-clear-btn" class="clear-btn"
                    style="display:none; margin-left:auto; margin-right:10px;">🗑️ 一鍵刪除</button>
                <button class="close-btn" onclick="closeHistory()" style="color:#fff;font-size:1.5rem;">×</button>
            </div>
            <div class="ad-container" style="margin: 10px; width: auto;"><span class="ad-label">贊助商廣告 (申請後顯示)</span>
            </div>
            <div class="history-list" id="history-list"></div>
        </div>
    </div>
    <div id="upload-history-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="history-header"><span>OSM 上傳紀錄</span><button class="clear-btn"
                    onclick="clearUploadHistory()">🗑️ 清除</button><button class="close-btn"
                    onclick="closeUploadHistory()" style="color:#fff;font-size:1.5rem;">×</button></div>
            <div class="history-list" id="upload-history-list"></div>
        </div>
    </div>
    <div id="help-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="history-header"><span>關於本系統</span><button class="close-btn" onclick="closeHelp()"
                    style="color:#fff;font-size:1.5rem;">×</button></div>
            <div class="help-content">
                <h3>🚀 如何開始？</h3>
                <ul>
                    <li>請務必點擊主畫面的藍色 <b>「🚀 啟動偵測」</b> 按鈕，才能開始背景監控與警報。</li>
                    <li>第一次啟動時，請允許 <b>GPS 權限</b> 與 <b>音效播放</b>。</li>
                </ul>
                <h3>🔊 警報模式</h3>
                <ul>
                    <li><b>黃色預警：</b> 超過速限但未達扣牌標準，發出短促「嗶嗶聲」。</li>
                    <li><b>紅色警報：</b> 超過扣牌標準 (速限+38)，螢幕閃爍並語音大喊「嚴重超速」。</li>
                </ul>
                <h3>🎨 儀表板主題</h3>
                <ul>
                    <li>在左上角選單中，您可以切換 <b>「🔢 數位」</b> 或 <b>「⌚ 指針」</b> 兩種風格。</li>
                </ul>
                <h3>📍 速限回報 / 修改</h3>
                <ul>
                    <li><b>直接修改：</b> <span style="color:#ff9800">點擊主畫面的速限圓圈</span>，即可直接修正該路段速限。</li>
                    <li><b>一鍵標記：</b> 點擊橘色「📍 標記缺漏」可快速記錄。</li>
                    <li><b>上傳 OSM：</b> 在側邊選單的「查看缺漏回報」中，可將資料上傳至 OpenStreetMap。</li>
                </ul>
                <h3>🗺️ 顯示模式</h3>
                <ul>
                    <li><b>HUD 模式：</b> 點擊選單中的 <b>🪞 切換 HUD</b>，畫面上下顛倒。</li>
                    <li><b>小地圖：</b> 點擊 <b>🗺️ 地圖</b> 開啟。直向時懸浮右下角；橫向時變身為儀表板背景。</li>
                </ul>
                <h3>📱 PWA 安裝</h3>
                <ul>
                    <li><b>Android：</b> 點擊瀏覽器選單 ->「加到主畫面」。</li>
                    <li><b>iOS：</b> 點擊分享按鈕 ->「加入主畫面」。</li>
                </ul>
                <h3>⚠️ 注意事項</h3>
                <ul>
                    <li>本網頁版具備「防休眠」功能，但請盡量保持螢幕開啟以獲得最佳 GPS 訊號。</li>
                    <li>速限資料來自 OpenStreetMap (OSM)，僅供參考，請以實際路況為準。</li>
                </ul>
                <div class="help-footer">作者:MiniKao<br>Web Version 2.16<br>Designed for Safe Driving</div>
            </div>
        </div>
    </div>
    <div id="map-modal" class="modal-overlay">
        <div class="modal-container" style="height: 90%; max-width: 800px;">
            <div id="map-container"><button class="back-btn" onclick="closeMap()">⬅️ 返回列表</button>
                <div id="trip-map"></div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="dashboard">
            <div id="mini-map-overlay">
                <div id="realtime-map"></div>
            </div>

            <div id="speed-display">0</div>

            <canvas id="analog-gauge" width="400" height="400"></canvas>

            <div class="info-area">
                <div class="limit-container">
                    <div id="visual-limit" class="limit-sign unknown" onclick="editCurrentLimit()">?</div>
                    <button id="report-btn" onclick="quickMarkMissing()">📍 標記缺漏</button>
                </div>
                <div class="threshold-info">
                    <div class="threshold-badge">扣牌: <span id="alarm-threshold-text">88</span></div>
                    <span id="limit-source-text" class="limit-source">等待 GPS...</span>
                </div>
            </div>
        </div>
        <div class="primary-controls">
            <div class="control-group-left">
                <div class="quick-presets">
                    <button class="preset-btn" onclick="setLimit(30)">30</button>
                    <button class="preset-btn" onclick="setLimit(40)">40</button>
                    <button class="preset-btn" onclick="setLimit(50)">50</button>
                </div>
                <div class="adjust-row">
                    <button class="adjust-btn" id="btn-minus">-10</button>
                    <input type="number" id="limit-input" value="50">
                    <button class="adjust-btn" id="btn-plus">+10</button>
                </div>
            </div>
            <button id="toggle-btn">🚀 啟動偵測</button>
        </div>
    </div>

    <script src="script.js"></script>
</body>

</html>