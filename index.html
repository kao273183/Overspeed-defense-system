<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é˜²æ‰£ç‰Œé è­¦ç³»çµ±</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-512.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow: hidden; 
            height: 100vh; height: 100dvh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            touch-action: manipulation;
            transition: background-color 0.1s;
        }

        body.hud-mode .main-container { transform: scaleY(-1); }

        /* ç‹€æ…‹é¡è‰² */
        body.danger { background-color: #b71c1c; animation: flash-red 0.5s infinite alternate; }
        @keyframes flash-red { from { background-color: #b71c1c; } to { background-color: #ff0000; } }
        
        body.warning { background-color: #fbc02d; animation: flash-yellow 0.8s infinite alternate; }
        body.warning #speed-display { color: #000; text-shadow: none; }
        body.warning .text-info { color: #333; }
        body.warning #location-display { background: rgba(0,0,0,0.8); color: #fff; } 
        body.warning .extra-info { color: #333; text-shadow: none; }
        @keyframes flash-yellow { from { background-color: #fbc02d; } to { background-color: #ffeb3b; } }

        /* --- é ‚éƒ¨æŒ‰éˆ• --- */
        #menu-btn {
            position: absolute; top: 15px;
            left: max(20px, env(safe-area-inset-left));
            font-size: 1.8rem; background: none; border: none; color: #0f0; 
            cursor: pointer; z-index: 100; padding: 5px; opacity: 0.9;
        }

        #hud-btn {
            position: absolute; top: 20px; 
            left: max(60px, calc(env(safe-area-inset-left) + 40px));
            font-size: 1rem; background: #333; border: 1px solid #555; color: #0f0; 
            cursor: pointer; z-index: 100; padding: 4px 10px; border-radius: 6px; opacity: 0.9;
            font-weight: bold;
        }

        #minimap-btn {
            position: absolute; top: 20px; 
            left: max(125px, calc(env(safe-area-inset-left) + 105px));
            font-size: 1rem; background: #333; border: 1px solid #555; color: #fff; 
            cursor: pointer; z-index: 100; padding: 4px 10px; border-radius: 6px; opacity: 0.9;
            font-weight: bold;
        }

        #clock {
            position: absolute; top: 15px; 
            right: max(20px, env(safe-area-inset-right));
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem; font-weight: bold; color: #0f0;
            background: #222; padding: 4px 10px; border-radius: 8px;
            letter-spacing: 1px; z-index: 90;
        }

        /* --- ç›´å‘ä½ˆå±€ (é è¨­) --- */
        #location-display {
            position: absolute; top: 85px; 
            left: 50%; transform: translateX(-50%);
            font-size: 1rem; color: #4caf50; 
            background: #333; 
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 80;
            max-width: 80%;
            display: flex; align-items: center; gap: 5px;
            transition: all 0.3s;
        }
        #location-display::before { content: 'ğŸ“'; filter: hue-rotate(320deg); font-size: 1.1rem; }

        .extra-info {
            position: absolute; z-index: 85;
            font-family: monospace; color: #aaa; font-size: 1.1rem; font-weight: bold;
            display: flex; gap: 15px;
            top: 135px; left: 50%; transform: translateX(-50%);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transition: all 0.3s;
        }

        .main-container {
            display: flex; flex-direction: column; 
            align-items: center; justify-content: space-between; 
            width: 100%; height: 100%; 
            padding: 10px; 
            padding-top: 160px;
        }

        .dashboard {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            width: 100%; 
            transition: gap 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        /* æ•¸ä½æ™‚é€Ÿè¡¨ (é è¨­) */
        #speed-display {
            font-weight: bold; line-height: 1; text-shadow: 0 0 20px rgba(0,255,0,0.8);
            color: #0f0; font-size: 28vh; margin: 0; padding: 0; transition: color 0.2s, transform 0.5s;
            font-family: 'Arial Black', sans-serif;
            z-index: 10; 
            display: block; /* é è¨­é¡¯ç¤º */
        }
        #speed-display::after {
            content: 'km/h'; display: block; font-size: 1.5rem; 
            color: #0f0; text-align: center; font-weight: normal; margin-top: -10px; text-shadow: none; opacity: 0.8;
        }

        /* [æ–°å¢] æŒ‡é‡æ™‚é€Ÿè¡¨ */
        #analog-gauge {
            display: none; /* é è¨­éš±è— */
            width: 35vh; height: 35vh; /* è·Ÿæ•¸ä½å­—é«”å·®ä¸å¤šå¤§ */
            max-width: 300px; max-height: 300px;
            z-index: 10;
        }

        /* [ä¸»é¡Œ] ç•¶ Body æœ‰ analog-theme class æ™‚ */
        body.theme-analog #speed-display { display: none; }
        body.theme-analog #analog-gauge { display: block; }

        body.danger #speed-display { color: #fff; text-shadow: none; }
        body.danger #speed-display::after { color: #fff; }

        .info-area { 
            display: flex; align-items: center; gap: 20px; margin-top: 10px; opacity: 0.9; z-index: 10; 
            transition: transform 0.5s;
        }
        .limit-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        
        .limit-sign {
            width: 80px; height: 80px; background-color: #fff;
            border: 10px solid #cc0000; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #000; font-weight: bold; font-size: 36px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); font-family: Arial, sans-serif; transition: all 0.3s;
            cursor: pointer; user-select: none;
        }
        .limit-sign:active { transform: scale(0.9); }
        .limit-sign.unknown { border-color: #777; color: #777; font-size: 40px; } 
        
        #report-btn {
            margin-top: 10px; background: #ff9800; color: #000; font-weight: bold;
            border: none; padding: 8px 16px; border-radius: 20px; font-size: 1rem;
            cursor: pointer; display: none; animation: pop 0.3s ease-out; box-shadow: 0 0 10px #ff9800;
        }
        #report-btn:active { transform: scale(0.95); }
        @keyframes pop { from {transform: scale(0);} to {transform: scale(1);} }

        .threshold-info { display: flex; flex-direction: column; align-items: flex-start; }
        .threshold-badge { 
            color: #ffeb3b; border: 1px solid #555; padding: 4px 8px; 
            border-radius: 6px; background: rgba(0,0,0,0.6); 
            font-size: 0.9rem; margin-bottom: 5px;
            white-space: nowrap; 
        }
        body.warning .threshold-badge { color: #000; border-color: #333; }
        .limit-source { font-size: 0.75rem; color: #4caf50; font-weight: bold; white-space: nowrap; }

        /* ç›´å‘æ¨¡å¼çš„å°åœ°åœ– */
        #mini-map-overlay {
            position: fixed;
            display: none; 
            z-index: 5;
            bottom: 140px; right: 10px;
            width: 140px; height: 140px;
            border: 2px solid #444;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            background: #222; 
        }
        #realtime-map { width: 100%; height: 100%; }
        
        /* åº•éƒ¨æ§åˆ¶å€ */
        .primary-controls { 
            width: 94%; max-width: 400px; 
            display: flex; flex-direction: column; gap: 10px; 
            background: #1c1c1e; padding: 15px; 
            border-radius: 20px; margin-bottom: 10px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); transition: all 0.3s; 
        }
        .control-group-left { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .quick-presets { display: flex; gap: 8px; width: 100%; }
        .preset-btn { background: #3a3a3c; color: #fff; border: none; padding: 12px 0; font-size: 1rem; border-radius: 8px; flex: 1; font-weight: bold; }
        .preset-btn:active { background: #555; }
        .adjust-row { display: flex; align-items: center; gap: 8px; height: 45px; }
        .adjust-btn { background: #3a3a3c; color: white; border: none; flex: 0 0 60px; height: 100%; font-size: 1.2rem; border-radius: 8px; cursor: pointer; }
        input[type="number"] { flex-grow: 1; min-width: 50px; height: 100%; font-size: 1.5rem; font-weight: bold; border-radius: 8px; border: none; text-align: center; background: #2c2c2e; color: #fff; padding: 0; }
        #toggle-btn { width: 100%; padding: 15px; font-size: 1.2rem; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; color: white; background-color: #007aff; display: flex; align-items: center; justify-content: center; gap: 8px; }
        #toggle-btn.active { background-color: #ff3b30; }

        /* --- å´é‚Šé¸å–® --- */
        #settings-drawer { position: fixed; top: 0; left: 0; width: 85%; max-width: 350px; height: 100%; background: rgba(25, 25, 25, 0.98); backdrop-filter: blur(15px); box-shadow: 4px 0 15px rgba(0,0,0,0.6); padding: 25px; transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 200; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }
        #settings-drawer.open { transform: translateX(0); }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 150; }
        #overlay.show { display: block; }
        .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .drawer-title { font-size: 1.3rem; font-weight: bold; color: #eee; }
        .close-btn { background: none; border: none; color: #aaa; font-size: 1.8rem; cursor: pointer; padding: 0 5px; }
        .drawer-btn { width: 100%; padding: 12px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; color: white; margin-top: 10px; font-weight: bold; margin-bottom: 10px; transition: opacity 0.2s; }
        .drawer-btn:active { opacity: 0.8; }
        #help-btn { background-color: #607d8b; }
        #history-btn { background-color: #007aff; }
        #osm-report-btn { background-color: #e91e63; }
        #upload-history-btn { background-color: #009688; }
        #test-tts-btn { background-color: #28a745; }
        .ad-container { width: 100%; min-height: 100px; background: #222; border: 1px dashed #555; display: none; align-items: center; justify-content: center; color: #777; font-size: 0.9rem; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        .ad-label { display: block; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; }
        .modal-container { width: 90%; max-width: 500px; height: 85%; background: #1c1c1e; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #333; }
        .history-header { padding: 20px; background: #2c2c2e; font-weight: bold; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item { background: #2c2c2e; margin-bottom: 10px; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 8px; }
        .h-date { color: #888; font-size: 0.8rem; }
        .h-stats { display: flex; justify-content: space-between; font-size: 1rem; font-weight: bold; margin-top: 5px; }
        .h-stat-box { text-align: center; }
        .h-label { font-size: 0.7rem; color: #aaa; display: block; }
        .h-val { color: #fff; }
        .h-val.max { color: #ff3b30; }
        .empty-msg { text-align: center; color: #666; margin-top: 50px; }
        .btn-link { background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; text-decoration: none; display:inline-block; }
        .btn-set-speed { background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px; margin-right: 5px; border-radius: 5px; cursor: pointer; }
        .btn-upload { background: #007aff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-right: 10px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-upload:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        .btn-gpx { background: #9c27b0; margin-left: 5px; }
        .clear-btn { color: #ff3b30; background: none; border: none; font-size: 0.9rem; cursor: pointer; }
        
        .help-content { padding: 20px; color: #ddd; line-height: 1.6; overflow-y: auto; }
        .help-content h3 { color: #007aff; margin-top: 0; }
        .help-content ul { padding-left: 20px; margin-bottom: 20px; }
        .help-content li { margin-bottom: 10px; }
        .help-footer { margin-top: 20px; text-align: center; font-size: 0.8rem; color: #666; border-top: 1px solid #333; padding-top: 10px; }
        
        #map-container { flex: 1; width: 100%; position: relative; }
        #trip-map { width: 100%; height: 100%; background: #000; }
        .back-btn { position: absolute; top: 20px; right: 20px; left: auto; z-index: 2000; background: #007aff; color: #fff; border: none; padding: 10px 24px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.6); transition: transform 0.1s; }
        .back-btn:active { transform: scale(0.95); }
        .input-group { text-align: left; width: 100%; }
        .input-group label { display: block; color: #bbb; font-size: 0.95rem; margin-bottom: 8px; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #555; background: #333; color: #fff; box-sizing: border-box; }
        .file-upload { position: relative; overflow: hidden; display: block; width: 100%; }
        .file-upload input[type="file"] { position: absolute; top: 0; right: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-btn { background-color: #333; color: #ddd; padding: 12px; border-radius: 8px; display: block; text-align: center; border: 1px dashed #777; font-size: 0.9rem; }
        #status { margin-top: auto; padding-bottom: 10px; font-size: 0.8rem; color: #666; text-align: center; }
        #pip-canvas { display: none; }
        #pip-video { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; }

        /* =========================================
           ğŸ“± æ©«å‘æ¨¡å¼ (Landscape) - æ‰‹æ©Ÿå°ˆå±¬å„ªåŒ–
           ========================================= */
        @media (orientation: landscape) {
            .main-container { 
                padding: 5px 60px; /* [ç˜¦èº«] æ¸›å°‘ä¸Šä¸‹ padding */
                padding-top: 50px; 
                justify-content: flex-end; 
            }
            
            .dashboard { 
                flex-direction: row; 
                align-items: center; 
                justify-content: center; 
                gap: 30px; 
                margin-bottom: 10px; /* [ç˜¦èº«] æ¸›å°‘åº•éƒ¨é‚Šè· */
                width: 100%;
            }

            .dashboard.map-active {
                gap: 35vw; /* [ç˜¦èº«] ç¸®å°åœ°åœ–æ¨é–‹è·é›¢ */
            }
            
            #speed-display { 
                font-size: 28vh; /* [ç˜¦èº«] ç¸®å°å­—é«” */
                text-align: center; line-height: 0.9; 
                z-index: 10;
            }

            /* æ©«å‘æ¨¡å¼çš„æŒ‡é‡ä¹Ÿè¦èª¿æ•´å¤§å° */
            #analog-gauge {
                width: 45vh; height: 45vh;
            }
            
            .info-area { margin-top: 0; flex-direction: row; z-index: 10; gap: 10px; /* [ç˜¦èº«] ç¸®å° gap */ }
            
            /* [ç˜¦èº«] ç¸®å°é™é€Ÿç‰Œ */
            .limit-sign { 
                width: 100px; height: 100px; font-size: 45px; border-width: 8px; 
            }
            .limit-sign.unknown { font-size: 60px; }
            
            #mini-map-overlay {
                position: absolute;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%);
                width: 35vw; /* [ç˜¦èº«] ç¸®å°åœ°åœ–å¯¬åº¦ */
                height: 55vh; 
                max-width: none; max-height: none;
                border-radius: 20px;
                border: none;
                background: transparent;
                box-shadow: none;
                -webkit-mask-image: radial-gradient(circle, black 60%, transparent 95%);
                mask-image: radial-gradient(circle, black 60%, transparent 95%);
                z-index: 1;
                margin: 0;
            }

            /* [ç˜¦èº«] åº•éƒ¨æ§åˆ¶å€å„ªåŒ– */
            .primary-controls { 
                max-width: 850px; width: 98%; 
                flex-direction: row; align-items: stretch; 
                padding: 8px 20px; /* æ¸›å°‘å…§è· */
                background: #1c1c1e; gap: 10px; z-index: 20; 
                height: 55px; /* å¼·åˆ¶ç¸®å°é«˜åº¦ */
                overflow: hidden; /* é˜²æ­¢æº¢å‡º */
            }
            
            .control-group-left { 
                flex: 2; justify-content: center; gap: 5px; 
                flex-direction: row; /* æ”¹æˆæ©«å‘æ’åˆ— */
                align-items: center;
            }
            
            .quick-presets { display: none; /* [ç˜¦èº«] æ©«å‘æ™‚éš±è—å¿«é€ŸæŒ‰éˆ•ï¼Œç¯€çœç©ºé–“ */ }
            
            /* èª¿æ•´æŒ‰éˆ•å¤§å° */
            #toggle-btn { 
                flex: 1; font-size: 1.1rem; height: 100%; padding: 0; 
                white-space: nowrap;
            }
            
            .adjust-row { height: 100%; width: 100%; }
            .adjust-btn { width: 50px; font-size: 1.2rem; }
            input[type="number"] { font-size: 1.3rem; }

            #location-display { top: 15px; max-width: 50%; font-size: 0.9rem; padding: 5px 15px; }
            .extra-info { top: 55px; right: 20px; left: auto; transform: none; flex-direction: column; gap: 2px; align-items: flex-end; font-size: 0.9rem; }
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

    <button id="menu-btn" onclick="toggleMenu()">â˜°</button>
    <button id="hud-btn" onclick="toggleHud()">HUD</button>
    <button id="minimap-btn" onclick="toggleMiniMap()">ğŸ—ºï¸ åœ°åœ–</button>

    <div id="location-display">ğŸ“ å®šä½ä¸­...</div> 
    <div id="clock">--:--</div>

    <div class="extra-info">
        <span id="altitude-display">Alt: --m</span>
        <span id="heading-display">---</span>
    </div>

    <canvas id="pip-canvas" width="512" height="512"></canvas>
    <video id="pip-video" muted playsinline></video>
    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="settings-drawer">
        <div class="drawer-header">
            <span class="drawer-title">é€²éšè¨­å®š</span>
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
        </div>
        
        <div class="ad-container">
            <span class="ad-label">è´ŠåŠ©å•†å»£å‘Š (ç”³è«‹å¾Œé¡¯ç¤º)</span>
        </div>

        <div class="input-group">
            <label>ç³»çµ±è³‡è¨Š</label>
            <button class="drawer-btn" id="help-btn" onclick="showHelp()">â„¹ï¸ ä½¿ç”¨èªªæ˜ / é—œæ–¼</button>
        </div>

        <div class="input-group">
            <label>å„€è¡¨æ¿é¢¨æ ¼</label>
            <div style="display:flex; gap:10px;">
                <button class="drawer-btn" style="background:#444;" onclick="setTheme('digital')">ğŸ”¢ æ•¸ä½</button>
                <button class="drawer-btn" style="background:#444;" onclick="setTheme('analog')">âŒš æŒ‡é‡</button>
            </div>
        </div>

        <div class="input-group">
            <label>è³‡æ–™ç®¡ç†</label>
            <button class="drawer-btn" id="history-btn" onclick="showHistory()">ğŸ“Š æŸ¥çœ‹è¡Œè»Šç´€éŒ„</button>
            <button class="drawer-btn" id="osm-report-btn" onclick="showOsmReports()">ğŸ“ æŸ¥çœ‹ç¼ºæ¼å›å ±</button>
            <button class="drawer-btn" id="upload-history-btn" onclick="showUploadHistory()">â˜ï¸ æŸ¥çœ‹ä¸Šå‚³ç´€éŒ„</button>
        </div>
        <div class="input-group">
            <label>OSM è‡ªå‹•é€Ÿé™</label>
            <div style="display: flex; flex-direction: column; gap: 10px; background: #333; padding: 10px; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="auto-limit-check" checked style="width: 20px; height: 20px; accent-color: #2979ff;"> 
                    <span style="font-size: 1rem; color: #fff;">å•Ÿç”¨è‡ªå‹•åµæ¸¬</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; border-top: 1px solid #555; padding-top: 10px;">
                    <input type="checkbox" id="auto-log-check" style="width: 20px; height: 20px; accent-color: #ff3b30;"> 
                    <span style="font-size: 1rem; color: #ff9800;">ğŸŸ¥ è‡ªå‹•ç´€éŒ„ç¼ºæ¼</span>
                </div>
            </div>
        </div>
        <div class="input-group">
            <label>åš´é‡è¶…é€ŸèªéŸ³ (TTS)</label>
            <input type="text" id="voice-text" value="åš´é‡è¶…é€Ÿï¼è«‹ç…è»Š">
            <button class="drawer-btn" id="test-tts-btn">ğŸ—£ï¸ æ¸¬è©¦èªéŸ³</button>
        </div>
        <div id="status">æº–å‚™å°±ç·’</div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="history-header"><span id="modal-title">è¡Œè»Šç´€éŒ„</span><button class="close-btn" onclick="closeHistory()" style="color:#fff;font-size:1.5rem;">Ã—</button></div>
            <div class="ad-container" style="margin: 10px; width: auto;"><span class="ad-label">è´ŠåŠ©å•†å»£å‘Š (ç”³è«‹å¾Œé¡¯ç¤º)</span></div>
            <div class="history-list" id="history-list"></div>
        </div>
    </div>
    <div id="upload-history-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="history-header"><span>OSM ä¸Šå‚³ç´€éŒ„</span><button class="clear-btn" onclick="clearUploadHistory()">ğŸ—‘ï¸ æ¸…é™¤</button><button class="close-btn" onclick="closeUploadHistory()" style="color:#fff;font-size:1.5rem;">Ã—</button></div>
            <div class="history-list" id="upload-history-list"></div>
        </div>
    </div>
    <div id="help-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="history-header"><span>é—œæ–¼æœ¬ç³»çµ±</span><button class="close-btn" onclick="closeHelp()" style="color:#fff;font-size:1.5rem;">Ã—</button></div>
            <div class="help-content">
                <h3>ğŸš€ å¦‚ä½•é–‹å§‹ï¼Ÿ</h3>
                <ul>
                    <li>è«‹å‹™å¿…é»æ“Šä¸»ç•«é¢çš„è—è‰² <b>ã€ŒğŸš€ å•Ÿå‹•åµæ¸¬ã€</b> æŒ‰éˆ•ï¼Œæ‰èƒ½é–‹å§‹èƒŒæ™¯ç›£æ§èˆ‡è­¦å ±ã€‚</li>
                    <li>ç¬¬ä¸€æ¬¡å•Ÿå‹•æ™‚ï¼Œè«‹å…è¨± <b>GPS æ¬Šé™</b> èˆ‡ <b>éŸ³æ•ˆæ’­æ”¾</b>ã€‚</li>
                </ul>

                <h3>ğŸ”Š è­¦å ±æ¨¡å¼</h3>
                <ul>
                    <li><b>é»ƒè‰²é è­¦ï¼š</b> è¶…éé€Ÿé™ä½†æœªé”æ‰£ç‰Œæ¨™æº–ï¼Œç™¼å‡ºçŸ­ä¿ƒã€Œå—¶å—¶è²ã€ã€‚</li>
                    <li><b>ç´…è‰²è­¦å ±ï¼š</b> è¶…éæ‰£ç‰Œæ¨™æº– (é€Ÿé™+38)ï¼Œè¢å¹•é–ƒçˆä¸¦èªéŸ³å¤§å–Šã€Œåš´é‡è¶…é€Ÿã€ã€‚</li>
                </ul>

                <h3>ğŸ¨ å„€è¡¨æ¿ä¸»é¡Œ</h3>
                <ul>
                    <li>åœ¨å·¦ä¸Šè§’é¸å–®ä¸­ï¼Œæ‚¨å¯ä»¥åˆ‡æ› <b>ã€ŒğŸ”¢ æ•¸ä½ã€</b> æˆ– <b>ã€ŒâŒš æŒ‡é‡ã€</b> å…©ç¨®é¢¨æ ¼ã€‚</li>
                </ul>

                <h3>ğŸ“ é€Ÿé™å›å ± / ä¿®æ”¹</h3>
                <ul>
                    <li><b>ç›´æ¥ä¿®æ”¹ï¼š</b> <span style="color:#ff9800">é»æ“Šä¸»ç•«é¢çš„é€Ÿé™åœ“åœˆ</span>ï¼Œå³å¯ç›´æ¥ä¿®æ­£è©²è·¯æ®µé€Ÿé™ã€‚</li>
                    <li><b>ä¸€éµæ¨™è¨˜ï¼š</b> é»æ“Šæ©˜è‰²ã€ŒğŸ“ æ¨™è¨˜ç¼ºæ¼ã€å¯å¿«é€Ÿè¨˜éŒ„ã€‚</li>
                    <li><b>ä¸Šå‚³ OSMï¼š</b> åœ¨å´é‚Šé¸å–®çš„ã€ŒæŸ¥çœ‹ç¼ºæ¼å›å ±ã€ä¸­ï¼Œå¯å°‡è³‡æ–™ä¸Šå‚³è‡³ OpenStreetMapã€‚</li>
                </ul>

                <h3>ğŸ—ºï¸ é¡¯ç¤ºæ¨¡å¼</h3>
                <ul>
                    <li><b>HUD æ¨¡å¼ï¼š</b> é»æ“Šå·¦ä¸Šè§’ <b>HUD</b>ï¼Œç•«é¢ä¸Šä¸‹é¡›å€’ï¼Œé©åˆå¤œé–“æŠ•å½±æ“‹é¢¨ç»ç’ƒã€‚</li>
                    <li><b>å°åœ°åœ–ï¼š</b> é»æ“Š <b>ğŸ—ºï¸ åœ°åœ–</b> é–‹å•Ÿã€‚ç›´å‘æ™‚æ‡¸æµ®å³ä¸‹è§’ï¼›æ©«å‘æ™‚è®Šèº«ç‚ºå„€è¡¨æ¿èƒŒæ™¯ã€‚</li>
                </ul>
                
                <h3>ğŸ“± PWA å®‰è£</h3>
                <ul>
                    <li><b>Androidï¼š</b> é»æ“Šç€è¦½å™¨é¸å–® ->ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€ã€‚</li>
                    <li><b>iOSï¼š</b> é»æ“Šåˆ†äº«æŒ‰éˆ• ->ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚</li>
                </ul>

                <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
                <ul>
                    <li>æœ¬ç¶²é ç‰ˆå…·å‚™ã€Œé˜²ä¼‘çœ ã€åŠŸèƒ½ï¼Œä½†è«‹ç›¡é‡ä¿æŒè¢å¹•é–‹å•Ÿä»¥ç²å¾—æœ€ä½³ GPS è¨Šè™Ÿã€‚</li>
                    <li>é€Ÿé™è³‡æ–™ä¾†è‡ª OpenStreetMap (OSM)ï¼Œåƒ…ä¾›åƒè€ƒï¼Œè«‹ä»¥å¯¦éš›è·¯æ³ç‚ºæº–ã€‚</li>
                </ul>

                <div class="help-footer">ä½œè€…:MiniKao<br>Web Version 2.14<br>Designed for Safe Driving</div>
            </div>
        </div>
    </div>
    <div id="map-modal" class="modal-overlay">
        <div class="modal-container" style="height: 90%; max-width: 800px;">
            <div id="map-container"><button class="back-btn" onclick="closeMap()">â¬…ï¸ è¿”å›åˆ—è¡¨</button><div id="trip-map"></div></div>
        </div>
    </div>

    <div class="main-container">
        <div class="dashboard">
            <div id="mini-map-overlay">
                <div id="realtime-map"></div>
            </div>

            <div id="speed-display">0</div> 
            
            <canvas id="analog-gauge" width="400" height="400"></canvas>
            
            <div class="info-area">
                <div class="limit-container">
                    <div id="visual-limit" class="limit-sign unknown" onclick="editCurrentLimit()">?</div>
                    <button id="report-btn" onclick="quickMarkMissing()">ğŸ“ æ¨™è¨˜ç¼ºæ¼</button>
                </div>
                <div class="threshold-info">
                    <div class="threshold-badge">æ‰£ç‰Œ: <span id="alarm-threshold-text">88</span></div>
                    <span id="limit-source-text" class="limit-source">ç­‰å¾… GPS...</span>
                </div>
            </div>
        </div>
        <div class="primary-controls">
            <div class="control-group-left">
                <div class="quick-presets">
                    <button class="preset-btn" onclick="setLimit(30)">30</button>
                    <button class="preset-btn" onclick="setLimit(40)">40</button>
                    <button class="preset-btn" onclick="setLimit(50)">50</button>
                </div>
                <div class="adjust-row">
                    <button class="adjust-btn" id="btn-minus">-10</button> 
                    <input type="number" id="limit-input" value="50">
                    <button class="adjust-btn" id="btn-plus">+10</button> 
                </div>
            </div>
            <button id="toggle-btn">ğŸš€ å•Ÿå‹•åµæ¸¬</button>
        </div>
    </div>

    <script>
        const speedDisplay = document.getElementById('speed-display');
        const analogGauge = document.getElementById('analog-gauge'); // [æ–°å¢]
        const locationDisplay = document.getElementById('location-display');
        const limitInput = document.getElementById('limit-input');
        const visualLimit = document.getElementById('visual-limit');
        const limitSourceText = document.getElementById('limit-source-text');
        const alarmThresholdText = document.getElementById('alarm-threshold-text');
        const reportBtn = document.getElementById('report-btn');
        const hudBtn = document.getElementById('hud-btn');
        const minimapBtn = document.getElementById('minimap-btn'); 
        const altitudeDisplay = document.getElementById('altitude-display'); 
        const headingDisplay = document.getElementById('heading-display'); 
        
        const voiceTextInput = document.getElementById('voice-text');
        const toggleBtn = document.getElementById('toggle-btn');
        const testTtsBtn = document.getElementById('test-tts-btn');
        const btnMinus = document.getElementById('btn-minus');
        const btnPlus = document.getElementById('btn-plus');
        const clockEl = document.getElementById('clock');
        const statusDiv = document.getElementById('status');
        const autoLimitCheck = document.getElementById('auto-limit-check');
        const autoLogCheck = document.getElementById('auto-log-check'); 
        const drawer = document.getElementById('settings-drawer');
        const overlay = document.getElementById('overlay');
        const body = document.body;

        const historyModal = document.getElementById('history-modal');
        const historyListEl = document.getElementById('history-list');
        const modalTitle = document.getElementById('modal-title');
        const mapModal = document.getElementById('map-modal');
        const helpModal = document.getElementById('help-modal'); 
        const uploadHistoryModal = document.getElementById('upload-history-modal');
        const uploadHistoryList = document.getElementById('upload-history-list');
        
        const pipCanvas = document.getElementById('pip-canvas');
        const pipCtx = pipCanvas.getContext('2d');
        const pipVideo = document.getElementById('pip-video');

        let watchId = null;
        let wakeLock = null;
        let lastSpeakTime = 0;
        let lastBeepTime = 0; 
        let isMonitoring = false; 
        let lastOsmCheckTime = 0;
        let lastAddressCheckTime = 0; 
        let isFirstFix = true;

        let tripStartTime = null;
        let tripMaxSpeed = 0;
        let tripDistance = 0; 
        let currentTripPath = []; 
        let lastLat = null;
        let lastLon = null;
        let mapInstance = null;
        let polylineLayer = null;
        let currentMissingLat = null;
        let currentMissingLon = null;

        let miniMap = null;
        let miniMapMarker = null;
        let miniMapPolyline = null;
        let miniMapPath = [];

        let currentTheme = localStorage.getItem('speed_theme') || 'digital'; // [æ–°å¢]

        const TOLERANCE = 38; 
        const PRE_WARNING_BUFFER = 5; 
        const synth = window.speechSynthesis;

        window.addEventListener('load', () => {
            if (!localStorage.getItem('hasSeenHelp')) { showHelp(); localStorage.setItem('hasSeenHelp', 'true'); }
            // PWA disabled for dev
            // if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
            
            // åˆå§‹åŒ–ä¸»é¡Œ
            setTheme(currentTheme);
            drawGauge(0); // ç•«åˆå§‹ 0
        });

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            clockEl.textContent = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock(); 

        const silentAudio = new Audio();
        silentAudio.src = "data:audio/mp3;base64,SUQzBAAAAAABAFRYWFQAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhUAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhUAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==";
        silentAudio.loop = true; silentAudio.volume = 0.01; 

        let beepAudio = new Audio('./sound.mp3');
        function playCustomSound() {
            beepAudio.currentTime = 0;
            beepAudio.play().catch(e => console.log("Sound error", e));
        }

        testTtsBtn.addEventListener('click', () => { playCustomSound(); setTimeout(() => { speak(voiceTextInput.value || "æ¸¬è©¦èªéŸ³"); }, 1000); });

        window.toggleHud = function() {
            body.classList.toggle('hud-mode');
            if(body.classList.contains('hud-mode')) { hudBtn.style.color = "#ffeb3b"; hudBtn.style.borderColor = "#ffeb3b"; } 
            else { hudBtn.style.color = "#0f0"; hudBtn.style.borderColor = "#555"; }
        };

        window.toggleMiniMap = function() {
            const el = document.getElementById('mini-map-overlay');
            const dashboard = document.querySelector('.dashboard'); 
            
            if (el.style.display === 'block') {
                el.style.display = 'none';
                minimapBtn.style.color = '#fff';
                dashboard.classList.remove('map-active'); 
            } else {
                el.style.display = 'block';
                minimapBtn.style.color = '#00e676';
                dashboard.classList.add('map-active'); 
                
                if (!miniMap) initMiniMap();
                else { 
                    setTimeout(() => { miniMap.invalidateSize(); }, 100); 
                }
            }
        };

        // --- ä¸»é¡Œåˆ‡æ›é‚è¼¯ ---
        window.setTheme = function(theme) {
            currentTheme = theme;
            localStorage.setItem('speed_theme', theme);
            
            if (theme === 'analog') {
                body.classList.add('theme-analog');
            } else {
                body.classList.remove('theme-analog');
            }
            if(drawer.classList.contains('open')) toggleMenu(); // é—œé–‰é¸å–®
        };

        // --- æŒ‡é‡å„€è¡¨æ¿ç¹ªè£½ ---
        function drawGauge(speed) {
            const canvas = analogGauge;
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const r = w / 2 - 20;

            // æ¸…ç©º
            ctx.clearRect(0, 0, w, h);

            // åˆ¤æ–·é¡è‰²ç‹€æ…‹
            let mainColor = '#0f0'; // ç¶ è‰²
            if (body.classList.contains('danger')) mainColor = '#fff'; // å±éšªè®Šç™½(å› ç‚ºèƒŒæ™¯ç´…)
            else if (body.classList.contains('warning')) mainColor = '#000'; // è­¦å‘Šè®Šé»‘(å› ç‚ºèƒŒæ™¯é»ƒ)

            // ç¹ªè£½å¤–åœˆ
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0.75 * Math.PI, 2.25 * Math.PI);
            ctx.lineWidth = 15;
            ctx.strokeStyle = '#333';
            ctx.stroke();

            // ç¹ªè£½åˆ»åº¦
            ctx.fillStyle = '#aaa';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i <= 240; i += 20) {
                const angle = 0.75 * Math.PI + (i / 240) * (1.5 * Math.PI);
                const tx = cx + (r - 35) * Math.cos(angle);
                const ty = cy + (r - 35) * Math.sin(angle);
                
                // å¤§åˆ»åº¦ç·š
                const x1 = cx + (r - 10) * Math.cos(angle);
                const y1 = cy + (r - 10) * Math.sin(angle);
                const x2 = cx + r * Math.cos(angle);
                const y2 = cy + r * Math.sin(angle);
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#fff';
                ctx.stroke();

                ctx.fillText(i, tx, ty);
            }

            // ç¹ªè£½æŒ‡é‡
            // é™åˆ¶æŒ‡é‡ä¸è¶…é 240
            const displaySpeed = Math.min(speed, 240);
            const needleAngle = 0.75 * Math.PI + (displaySpeed / 240) * (1.5 * Math.PI);
            
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + (r - 20) * Math.cos(needleAngle), cy + (r - 20) * Math.sin(needleAngle));
            ctx.lineWidth = 8;
            ctx.strokeStyle = mainColor; // è·Ÿéš¨ç‹€æ…‹è®Šè‰²
            ctx.lineCap = 'round';
            
            // é™°å½±
            ctx.shadowBlur = 10;
            ctx.shadowColor = mainColor;
            ctx.stroke();
            ctx.shadowBlur = 0; // é‡ç½®

            // ä¸­å¿ƒåœ“é»
            ctx.beginPath();
            ctx.arc(cx, cy, 10, 0, 2 * Math.PI);
            ctx.fillStyle = '#555';
            ctx.fill();

            // æ•¸å­—é¡¯ç¤º (å°)
            ctx.fillStyle = mainColor;
            ctx.font = 'bold 40px Arial';
            ctx.fillText(Math.round(speed), cx, cy + 50);
            
            ctx.font = '16px Arial';
            ctx.fillStyle = '#888';
            ctx.fillText('km/h', cx, cy + 80);
        }

        function initMiniMap() {
            miniMap = L.map('realtime-map', { 
                zoomControl: false, 
                attributionControl: false 
            }).setView([25.0330, 121.5654], 18); 
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(miniMap);
            
            if (currentMissingLat && currentMissingLon) {
                updateMiniMap(currentMissingLat, currentMissingLon);
            }
        }

        function updateMiniMap(lat, lon) {
            if (!miniMap) return;
            const latlng = [lat, lon];
            if (!miniMapMarker) {
                miniMapMarker = L.circleMarker(latlng, { radius: 8, fillColor: '#2979ff', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(miniMap);
            } else { miniMapMarker.setLatLng(latlng); }
            
            miniMapPath.push(latlng);
            if (miniMapPath.length > 500) miniMapPath.shift(); 

            if (!miniMapPolyline) { miniMapPolyline = L.polyline(miniMapPath, { color: '#00e676', weight: 3 }).addTo(miniMap); } 
            else { miniMapPolyline.setLatLngs(miniMapPath); }
            
            miniMap.setView(latlng, 18); 
            miniMap.invalidateSize(); 
        }

        window.toggleMenu = function() {
            drawer.classList.toggle('open');
            if (drawer.classList.contains('open')) overlay.style.display = 'block';
            else overlay.style.display = 'none';
        };

        window.showHelp = function() { if(drawer.classList.contains('open')) toggleMenu(); helpModal.classList.add('show'); }
        window.closeHelp = function() { helpModal.classList.remove('show'); }

        window.editCurrentLimit = function() {
            if (!currentMissingLat || !currentMissingLon) { alert("å°šæœªå®šä½ï¼Œç„¡æ³•ä¿®æ”¹"); return; }
            let defaultVal = limitInput.value || "50";
            const input = prompt("ä¿®æ­£æ­¤è·¯æ®µé€Ÿé™ç‚ºï¼š", defaultVal);
            if (input) {
                const newLimit = parseInt(input);
                if (!isNaN(newLimit)) {
                    saveCustomLimit(currentMissingLat, currentMissingLon, newLimit);
                    setLimit(newLimit);
                    alert(`âœ… å·²ä¿®æ­£ç‚º ${newLimit} km/hï¼Œä¸‹æ¬¡ç¶“éæœƒè‡ªå‹•å¥—ç”¨ã€‚`);
                }
            }
        };

        window.quickMarkMissing = function() {
            if (!currentMissingLat || !currentMissingLon) { alert("å°šæœªå®šä½ï¼Œç„¡æ³•æ¨™è¨˜"); return; }
            saveCustomLimit(currentMissingLat, currentMissingLon, null);
            reportBtn.textContent = "âœ… å·²æ¨™è¨˜"; reportBtn.style.background = "#4caf50";
            setTimeout(() => { reportBtn.textContent = "ğŸ“ æ¨™è¨˜ç¼ºæ¼"; reportBtn.style.background = "#ff9800"; reportBtn.style.display = 'none'; }, 2000);
            statusDiv.textContent = "å·²æ¨™è¨˜æ­¤è™•ï¼Œè«‹ç¨å¾Œè£œå¡«é€Ÿé™";
        };

        function saveCustomLimit(lat, lon, limit) {
            let reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            const index = reports.findIndex(r => Math.abs(r.lat - lat) < 0.0002 && Math.abs(r.lon - lon) < 0.0002);
            if (index !== -1) {
                if (limit !== undefined) { reports[index].limit = limit; reports[index].date = new Date().toLocaleString('zh-TW'); }
            } else {
                const newReport = { lat: lat, lon: lon, limit: limit, date: new Date().toLocaleString('zh-TW'), address: locationDisplay.textContent.replace('ğŸ“ ', '') };
                reports.push(newReport);
            }
            if (reports.length > 100) reports.shift();
            localStorage.setItem('osm_reports', JSON.stringify(reports));
        }

        function findCustomLimit(lat, lon) {
            const reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            for (let r of reports) {
                if (Math.abs(r.lat - lat) < 0.0005 && Math.abs(r.lon - lon) < 0.0005) return r.limit;
            }
            return undefined; 
        }

        window.updateReportSpeed = function(index, speed) {
            let reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            reports[index].limit = speed;
            localStorage.setItem('osm_reports', JSON.stringify(reports));
            showOsmReports(); 
        };

        function addToUploadHistory(report, noteId) {
            let history = JSON.parse(localStorage.getItem('osm_uploaded_history') || "[]");
            history.unshift({ ...report, uploadDate: new Date().toLocaleString('zh-TW'), noteId: noteId });
            if (history.length > 50) history.pop();
            localStorage.setItem('osm_uploaded_history', JSON.stringify(history));
        }

        window.uploadToOsm = function(index) {
            let reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            const r = reports[index];
            if (!r || !r.limit) { alert("è«‹å…ˆè¨­å®šé€Ÿé™å¾Œå†ä¸Šå‚³"); return; }
            const btn = document.getElementById(`upload-btn-${index}`);
            if(btn) { btn.disabled = true; btn.textContent = "ä¸Šå‚³ä¸­..."; }
            const text = `User reported maxspeed: ${r.limit} km/h (via SpeedTrap WebApp)`;
            const url = `https://api.openstreetmap.org/api/0.6/notes.json?lat=${r.lat}&lon=${r.lon}&text=${encodeURIComponent(text)}`;
            fetch(url, { method: 'POST' }).then(response => response.json()).then(data => {
                const noteId = data.properties.id; const noteUrl = `https://www.openstreetmap.org/note/${noteId}`;
                addToUploadHistory(r, noteId); deleteReport(index);
                if(confirm(`âœ… ç­†è¨˜ä¸Šå‚³æˆåŠŸï¼(ID: ${noteId})\nå·²ç§»è‡³ã€Œä¸Šå‚³ç´€éŒ„ã€ã€‚\næ˜¯å¦è¦å‰å¾€ OSM æŸ¥çœ‹ï¼Ÿ`)) { window.open(noteUrl, '_blank'); }
            }).catch(err => {
                alert("âŒ ä¸Šå‚³å¤±æ•—\nè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚"); if(btn) { btn.disabled = false; btn.textContent = "â˜ï¸ ä¸Šå‚³ OSM ç­†è¨˜"; } console.error(err);
            });
        };

        window.showUploadHistory = function() {
            if(drawer.classList.contains('open')) toggleMenu();
            const history = JSON.parse(localStorage.getItem('osm_uploaded_history') || "[]");
            uploadHistoryList.innerHTML = "";
            if (history.length === 0) { uploadHistoryList.innerHTML = `<div class="empty-msg">å°šç„¡ä¸Šå‚³ç´€éŒ„</div>`; } else {
                history.forEach((h) => {
                    const noteUrl = `https://www.openstreetmap.org/note/${h.noteId}`;
                    const item = document.createElement('div'); item.className = 'history-item';
                    item.innerHTML = `<div class="h-date">ä¸Šå‚³æ–¼: ${h.uploadDate}</div><div style="font-size:1.1rem; font-weight:bold;">${h.address || "æœªçŸ¥è·¯æ®µ"}</div><div class="h-stats"><span>å›å ±é€Ÿé™: <span style="color:#0f0">${h.limit}</span></span></div><div style="margin-top:5px;"><a href="${noteUrl}" target="_blank" class="btn-link">ğŸ”— æŸ¥çœ‹ OSM ç­†è¨˜ (#${h.noteId})</a></div>`;
                    uploadHistoryList.appendChild(item);
                });
            }
            uploadHistoryModal.classList.add('show');
        }
        window.closeUploadHistory = function() { uploadHistoryModal.classList.remove('show'); }
        window.clearUploadHistory = function() { if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰ä¸Šå‚³ç´€éŒ„å—ï¼Ÿ")) { localStorage.removeItem('osm_uploaded_history'); showUploadHistory(); } }

        window.showOsmReports = function() {
            toggleMenu(); const reports = JSON.parse(localStorage.getItem('osm_reports') || "[]");
            modalTitle.textContent = "ç¼ºæ¼æ¨™è¨˜åˆ—è¡¨"; historyListEl.innerHTML = "";
            if (reports.length === 0) { historyListEl.innerHTML = `<div class="empty-msg">å°šç„¡æ¨™è¨˜ç´€éŒ„</div>`; } else {
                reports.forEach((r, idx) => {
                    const editLink = `https://www.openstreetmap.org/edit?editor=id#map=19/${r.lat}/${r.lon}`;
                    const isPending = (r.limit === null);
                    let speedControls = '', actionButtons = '';
                    if (isPending) {
                        speedControls = `<div style="margin-top:5px;"><span style="color:#ff9800; font-size:0.9rem;">å¿«é€Ÿè¨­å®š: </span><button class="btn-set-speed" onclick="updateReportSpeed(${idx}, 30)">30</button><button class="btn-set-speed" onclick="updateReportSpeed(${idx}, 40)">40</button><button class="btn-set-speed" onclick="updateReportSpeed(${idx}, 50)">50</button><button class="btn-set-speed" onclick="updateReportSpeed(${idx}, 60)">60</button></div>`;
                    } else {
                        speedControls = `<span style="color:#0f0">å·²è¨­å®š: ${r.limit} km/h</span>`;
                        actionButtons = `<button id="upload-btn-${idx}" class="btn-upload" onclick="uploadToOsm(${idx})">â˜ï¸ ä¸Šå‚³ OSM ç­†è¨˜</button>`;
                    }
                    const item = document.createElement('div'); item.className = 'history-item';
                    item.innerHTML = `<div class="h-date">${r.date}</div><div style="font-size:1.1rem; font-weight:bold;">${r.address || "æœªçŸ¥è·¯æ®µ"}</div><div class="h-stats">${speedControls}</div><div style="margin-top:8px; border-top:1px solid #444; padding-top:10px;">${actionButtons}<a href="${editLink}" target="_blank" class="btn-link">ğŸŒ é–‹å•Ÿç·¨è¼¯å™¨</a><button class="btn-link" style="background:#d32f2f; margin-left:10px;" onclick="deleteReport(${idx})">åˆªé™¤</button></div>`;
                    historyListEl.appendChild(item);
                });
            }
            historyModal.classList.add('show');
        }

        window.deleteReport = function(index) { let reports = JSON.parse(localStorage.getItem('osm_reports') || "[]"); reports.splice(index, 1); localStorage.setItem('osm_reports', JSON.stringify(reports)); showOsmReports(); }

        window.showHistory = function() { toggleMenu(); renderHistory(); historyModal.classList.add('show'); };
        window.closeHistory = function() { historyModal.classList.remove('show'); };
        window.clearHistory = function() { if(confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ')) { localStorage.removeItem('trip_records'); renderHistory(); } };

        window.downloadGpx = function(index) {
            const records = JSON.parse(localStorage.getItem('trip_records') || "[]"); const record = records[index];
            if(!record || !record.path || record.path.length === 0) { alert("ç„¡è»Œè·¡è³‡æ–™"); return; }
            let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="SpeedTrapWebApp"><trk><name>Trip on ${record.date}</name><trkseg>`;
            record.path.forEach(pt => { gpx += `\n<trkpt lat="${pt[0]}" lon="${pt[1]}"></trkpt>`; });
            gpx += `\n</trkseg></trk></gpx>`;
            const blob = new Blob([gpx], { type: 'application/gpx+xml' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `trip_${record.date.replace(/[\/:\s]/g, '_')}.gpx`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        window.showMap = function(index) {
            const records = JSON.parse(localStorage.getItem('trip_records') || "[]"); const record = records[index];
            if(!record || !record.path || record.path.length === 0) { alert("ç„¡è»Œè·¡è³‡æ–™"); return; }
            mapModal.classList.add('show');
            if (!mapInstance) { mapInstance = L.map('trip-map'); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(mapInstance); }
            if (polylineLayer) mapInstance.removeLayer(polylineLayer);
            setTimeout(() => { mapInstance.invalidateSize(); polylineLayer = L.polyline(record.path, { color: '#0f0', weight: 4, opacity: 0.8 }).addTo(mapInstance); mapInstance.fitBounds(polylineLayer.getBounds(), { padding: [50, 50] }); }, 100);
        };
        window.closeMap = function() { mapModal.classList.remove('show'); };

        function saveTrip() {
            if (!tripStartTime) return; const now = new Date(); const durationMs = now - tripStartTime; if (durationMs < 10000 && tripDistance < 0.1) return; 
            const hours = durationMs / 1000 / 3600; const avgSpeed = hours > 0 ? (tripDistance / hours) : 0;
            const record = { date: tripStartTime.toLocaleString('zh-TW'), duration: (durationMs / 1000 / 60).toFixed(1) + " åˆ†", distance: tripDistance.toFixed(1) + " km", maxSpeed: Math.round(tripMaxSpeed) + " km/h", avgSpeed: Math.round(avgSpeed) + " km/h", path: currentTripPath };
            let records = JSON.parse(localStorage.getItem('trip_records') || "[]"); records.unshift(record); if (records.length > 20) records.pop();
            localStorage.setItem('trip_records', JSON.stringify(records)); alert(`ğŸ è¡Œç¨‹çµæŸ\né‡Œç¨‹: ${record.distance}\næ™‚é–“: ${record.duration}`);
        }

        function renderHistory() {
            modalTitle.textContent = "è¡Œè»Šç´€éŒ„"; const records = JSON.parse(localStorage.getItem('trip_records') || "[]"); historyListEl.innerHTML = "";
            if (records.length === 0) { historyListEl.innerHTML = `<div class="empty-msg">å°šç„¡ç´€éŒ„</div>`; return; }
            records.forEach((r, index) => {
                const item = document.createElement('div'); item.className = 'history-item';
                item.innerHTML = `<div class="h-date">${r.date} - ${r.duration}</div><div class="h-stats"><div class="h-stat-box"><span class="h-label">æ¥µé€Ÿ</span><span class="h-val max">${r.maxSpeed}</span></div><div class="h-stat-box"><span class="h-label">å¹³å‡</span><span class="h-val">${r.avgSpeed}</span></div><div class="h-stat-box"><span class="h-label">é‡Œç¨‹</span><span class="h-val">${r.distance}</span></div></div><div style="margin-top:10px;"><button class="btn-link" style="margin-top:5px;background:#007aff;" onclick="showMap(${index})">ğŸ—ºï¸ æŸ¥çœ‹åœ°åœ–</button><button class="btn-link btn-gpx" onclick="downloadGpx(${index})">ğŸ’¾ ä¸‹è¼‰ GPX</button></div>`;
                historyListEl.appendChild(item);
            });
        }

        window.setLimit = function(val) {
            limitInput.value = val;
            let hasLocal = false;
            if (currentMissingLat && currentMissingLon) { const saved = findCustomLimit(currentMissingLat, currentMissingLon); if (saved !== undefined && saved !== null) { hasLocal = true; } }
            updateVisualSign(val, false, false, false, hasLocal); updateThresholdDisplay(); updatePiP(0, val);
        };
        btnMinus.addEventListener('click', () => setLimit(Math.max(0, (parseInt(limitInput.value)||0) - 10)));
        btnPlus.addEventListener('click', () => setLimit((parseInt(limitInput.value)||0) + 10));

        toggleBtn.addEventListener('click', () => { 
            silentAudio.play().catch(()=>{}); 
            // æ‰‹æ©ŸèªéŸ³ä¿®å¾©ï¼šå¼·åˆ¶è§£é– TTS
            speak(" ");
            if (!isMonitoring) startActiveMonitoring(); 
            else stopActiveMonitoring(); 
        });
        
        limitInput.addEventListener('input', () => { updateVisualSign(limitInput.value, false); updateThresholdDisplay(); updatePiP(0, limitInput.value); });

        function updateThresholdDisplay() { const base = parseInt(limitInput.value) || 0; alarmThresholdText.textContent = base + TOLERANCE; }
        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock(); });

        function initGPS() {
            if (navigator.geolocation) {
                statusDiv.textContent = "å®šä½ä¸­..."; locationDisplay.textContent = "å®šä½ä¸­...";
                watchId = navigator.geolocation.watchPosition(updatePosition, handleError, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            } else { alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS"); }
        }
        initGPS();

        async function startActiveMonitoring() {
            silentAudio.play().catch(()=>{}); playCustomSound(); 
            setTimeout(() => { speak("åµæ¸¬é–‹å§‹"); }, 800); 
            await requestWakeLock();
            tripStartTime = new Date(); tripMaxSpeed = 0; tripDistance = 0; currentTripPath = []; lastLat = null; lastLon = null;
            isMonitoring = true; toggleBtn.textContent = "ğŸ›‘ åœæ­¢åµæ¸¬"; toggleBtn.classList.add('active'); statusDiv.textContent = "âš ï¸ ç›£æ§ä¸­";
        }

        function stopActiveMonitoring() {
            if (wakeLock !== null) wakeLock.release(); silentAudio.pause(); saveTrip();
            isMonitoring = false; toggleBtn.textContent = "ğŸš€ å•Ÿå‹•åµæ¸¬"; toggleBtn.classList.remove('active');
            body.classList.remove('danger'); body.classList.remove('warning'); statusDiv.textContent = "å·²æš«åœ";
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = (lat2-lat1)*(Math.PI/180); const dLon = (lon2-lon1)*(Math.PI/180);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function updatePosition(position) {
            const lat = position.coords.latitude; const lon = position.coords.longitude;
            let speedMps = position.coords.speed; if (speedMps === null || speedMps < 0) speedMps = 0;
            const speedKmh = speedMps * 3.6;
            
            if (position.coords.altitude) altitudeDisplay.textContent = `Alt: ${Math.round(position.coords.altitude)}m`;
            if (position.coords.heading) {
                const deg = position.coords.heading;
                const dirs = ["åŒ—", "æ±åŒ—", "æ±", "æ±å—", "å—", "è¥¿å—", "è¥¿", "è¥¿åŒ—"];
                const idx = Math.round(deg / 45) % 8;
                headingDisplay.textContent = `${dirs[idx]} (${Math.round(deg)}Â°)`;
            }

            currentMissingLat = lat; currentMissingLon = lon;

            // æ›´æ–°å°åœ°åœ–
            if (document.getElementById('mini-map-overlay').style.display === 'block') {
                updateMiniMap(lat, lon);
            }

            if (isMonitoring) {
                if (lastLat !== null) {
                    const dist = getDistanceFromLatLonInKm(lastLat, lastLon, lat, lon);
                    if (speedKmh > 2 && dist > 0.0005 && dist < 0.2) tripDistance += dist;
                    if (dist > 0.01) currentTripPath.push([lat, lon]);
                } else currentTripPath.push([lat, lon]);
                if (speedKmh > tripMaxSpeed) tripMaxSpeed = speedKmh;
                lastLat = lat; lastLon = lon;
            }

            speedDisplay.innerHTML = `${Math.round(speedKmh)}`;
            if (currentTheme === 'analog') drawGauge(speedKmh); // [æ–°å¢] æ›´æ–°æŒ‡é‡

            const now = Date.now();
            const overpassServers = ["https://overpass-api.de/api/interpreter", "https://maps.mail.ru/osm/tools/overpass/api/interpreter", "https://overpass.kumi.systems/api/interpreter"];

            if (autoLimitCheck.checked && ( (now - lastOsmCheckTime > 15000 && speedKmh > 10) || isFirstFix ) ) {
                const savedLimit = findCustomLimit(lat, lon);
                if (savedLimit !== undefined) {
                    if (savedLimit !== null) { limitInput.value = savedLimit; updateVisualSign(savedLimit, false, true); updateThresholdDisplay(); } else { updateVisualSign(null, true); }
                } else {
                    (async () => {
                        let success = false;
                        const query = `[out:json];way[maxspeed](around:20,${lat},${lon});out tags;`;
                        for (const server of overpassServers) {
                            if(success) break;
                            try {
                                const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 3000);
                                const response = await fetch(`${server}?data=${encodeURIComponent(query)}`, { signal: controller.signal });
                                clearTimeout(timeoutId); if (!response.ok) throw new Error("Server busy");
                                const data = await response.json();
                                if (data.elements && data.elements.length > 0) {
                                    let maxspeed = data.elements[0].tags.maxspeed; let limitNumber = parseInt(maxspeed);
                                    if (!isNaN(limitNumber)) { limitInput.value = limitNumber; updateVisualSign(limitNumber, true); updateThresholdDisplay(); updatePiP(0, limitNumber); success = true; }
                                }
                            } catch (e) { console.warn("Switching server..."); }
                        }
                        if (!success) setDefaultLimit(lat, lon);
                    })();
                }
                lastOsmCheckTime = now; isFirstFix = false; 
            }
            if (now - lastAddressCheckTime > 15000) { fetchAddress(lat, lon); lastAddressCheckTime = now; }
            checkOverSpeed(speedKmh); updatePiP(speedKmh, limitInput.value);
        }

        function checkOverSpeed(currentSpeed) {
            if (!isMonitoring) { body.classList.remove('danger', 'warning'); return; }
            const baseLimit = parseFloat(limitInput.value);
            const alarmTrigger = baseLimit + TOLERANCE; 
            const preWarningStart = alarmTrigger - PRE_WARNING_BUFFER; 
            const now = Date.now();
            if (currentSpeed > alarmTrigger) {
                body.classList.remove('warning'); body.classList.add('danger');
                if (now - lastSpeakTime > 3000) { playCustomSound(); setTimeout(() => speak(voiceTextInput.value), 1000); lastSpeakTime = now; }
            } else if (currentSpeed > preWarningStart) {
                body.classList.remove('danger'); body.classList.add('warning');
                if (now - lastBeepTime > 1000) { playCustomSound(); lastBeepTime = now; }
            } else { body.classList.remove('danger', 'warning'); }
        }

        async function fetchAddress(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=zh-TW`;
            try {
                const response = await fetch(url); const data = await response.json();
                if (data && data.address) {
                    const road = data.address.road || ""; const suburb = data.address.suburb || data.address.city_district || ""; const city = data.address.city || "";
                    locationDisplay.textContent = road ? `${suburb} ${road}` : `${city} ${suburb}`;
                }
            } catch (err) {}
        }

        function setDefaultLimit(lat, lon) {
            const defaultVal = 50; limitInput.value = defaultVal; updateVisualSign(defaultVal, true, false, true); 
            updateThresholdDisplay(); updatePiP(0, defaultVal);
            if (autoLogCheck.checked && lat && lon) { saveCustomLimit(lat, lon, null); }
        }

        function updateVisualSign(val, isAuto, isCustom = false, isDefault = false, hasLocalOverride = false) {
            if (val && val > 0) {
                visualLimit.textContent = val; visualLimit.classList.remove('unknown');
                if (isDefault) {
                    limitSourceText.innerHTML = "âš ï¸ é è¨­ (ç„¡è³‡)"; limitSourceText.style.color = "#ff9800"; reportBtn.style.display = 'block'; 
                } else {
                    reportBtn.style.display = 'none'; 
                    if (isCustom) {
                        limitSourceText.innerHTML = "ğŸ“ æœ¬åœ°è¨˜æ†¶ (é»æ“Šä¿®æ”¹)"; limitSourceText.style.color = "#ff9800";
                    } else {
                        if (hasLocalOverride) { limitSourceText.innerHTML = "æ‰‹å‹•è¨­å®š<br><span style='color:#ff9800;font-size:0.7rem;'>å·²æœ‰ğŸ“ æœ¬åœ°è¨˜æ†¶<br>(é»æ“Šåœ–ç¤ºä¿®æ”¹)</span>"; limitSourceText.style.color = "#aaa"; } 
                        else { limitSourceText.innerHTML = isAuto ? "OSM è‡ªå‹•" : "æ‰‹å‹•è¨­å®š"; limitSourceText.style.color = isAuto ? "#4caf50" : "#aaa"; }
                    }
                }
            } else {
                visualLimit.textContent = "?"; visualLimit.classList.add('unknown'); limitSourceText.innerHTML = "âš ï¸ ç„¡é€Ÿé™è³‡æ–™"; limitSourceText.style.color = "#ff3b30"; reportBtn.style.display = 'block';
            }
        }

        // [æ‰‹æ©ŸèªéŸ³ä¿®å¾©] 
        function speak(text) {
            if (!synth) return;
            synth.cancel(); // é‡è¦ï¼šå…ˆå–æ¶ˆä¹‹å‰çš„ï¼Œé¿å…å¡ä½
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.rate = 1.0; 
            
            // å¼·åˆ¶æŠ“å–ä¸­æ–‡èªéŸ³ (ä¿®æ­£éƒ¨åˆ†æ‰‹æ©Ÿé è¨­è‹±æ–‡)
            const voices = synth.getVoices();
            const zhVoice = voices.find(v => v.lang.includes('zh-TW') || v.lang.includes('zh'));
            if (zhVoice) u.voice = zhVoice;

            synth.speak(u);
        }

        function handleError(error) { statusDiv.textContent = "âŒ GPS è¨Šè™Ÿéºå¤±"; locationDisplay.textContent = "GPS éºå¤±"; }
        
        // PiP Logic
        function updatePiP(currentSpeed, limit) {
            pipCtx.fillStyle = '#000000'; pipCtx.fillRect(0, 0, 512, 512);
            const baseLimit = parseInt(limit) || 0;
            let bgColor = '#000000';
            if (isMonitoring) {
                if (currentSpeed > baseLimit + TOLERANCE) bgColor = '#b71c1c'; 
                else if (currentSpeed > baseLimit + TOLERANCE - PRE_WARNING_BUFFER) bgColor = '#fbc02d'; 
            }
            if (bgColor !== '#000000') { pipCtx.fillStyle = bgColor; pipCtx.fillRect(0, 0, 512, 512); }
            pipCtx.fillStyle = (bgColor === '#b71c1c') ? '#fff' : (bgColor === '#fbc02d' ? '#000' : '#0f0');
            pipCtx.font = 'bold 250px Arial'; pipCtx.textAlign = 'center'; pipCtx.textBaseline = 'middle';
            pipCtx.fillText(Math.round(currentSpeed), 256, 200);
            pipCtx.beginPath(); pipCtx.arc(256, 400, 70, 0, 2 * Math.PI); pipCtx.fillStyle = '#fff'; pipCtx.fill();
            pipCtx.lineWidth = 10; pipCtx.strokeStyle = '#cc0000'; pipCtx.stroke();
            pipCtx.fillStyle = '#000'; pipCtx.font = 'bold 60px Arial'; pipCtx.fillText(baseLimit, 256, 403);
        }
    </script>
</body>
</html>