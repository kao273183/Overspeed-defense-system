<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰£ç‰Œé˜²ç¦¦è­¦ç¤º (é™é€Ÿ+38)</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
        }

        body.danger {
            background-color: #b71c1c; /* å±éšªæ™‚è®Šæ·±ç´… */
            animation: flash 0.5s infinite alternate; /* åŠ å¼·é–ƒçˆæ•ˆæœ */
        }

        @keyframes flash {
            from { background-color: #b71c1c; }
            to { background-color: #ff0000; }
        }

        /* --- ä¸»å„€è¡¨æ¿å€åŸŸ --- */
        .dashboard {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        #speed-display {
            font-size: 8rem;
            font-weight: bold;
            line-height: 1;
            text-shadow: 0 0 10px rgba(0,255,0,0.5);
            color: #0f0;
        }
        body.danger #speed-display { color: #fff; text-shadow: none; }
        
        .unit { font-size: 2rem; color: #aaa; }

        /* --- è¦–è¦ºåŒ–é™é€Ÿç‰Œ --- */
        .limit-container {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .limit-sign {
            width: 70px;
            height: 70px;
            background-color: #fff;
            border: 7px solid #cc0000;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #000;
            font-weight: bold;
            font-size: 2.2rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .limit-sign.unknown { border-color: #777; color: #777; }

        .limit-info { text-align: left; font-size: 0.9rem; color: #ccc; }

        /* --- è­¦å ±é–€æª»é¡¯ç¤º (æ–°åŠŸèƒ½) --- */
        .threshold-display {
            margin-top: 15px;
            font-size: 1.2rem;
            color: #ffeb3b; /* é»ƒè‰²æé†’ */
            font-weight: bold;
            border: 1px solid #555;
            padding: 5px 15px;
            border-radius: 20px;
            background: rgba(0,0,0,0.5);
        }

        /* --- æ§åˆ¶å€ --- */
        .controls {
            width: 90%;
            max-width: 400px;
            background: rgba(30, 30, 30, 0.9);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { display: block; margin-bottom: 3px; font-size: 0.9rem; color: #ccc; }

        input[type="number"], input[type="text"] {
            width: 100%; padding: 8px; font-size: 1.1rem;
            border-radius: 5px; border: none; box-sizing: border-box; 
        }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }

        button {
            padding: 12px; font-size: 1.1rem; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            color: white; flex: 1;
        }

        #test-btn { background-color: #28a745; }
        #toggle-btn { background-color: #2979ff; flex: 2; }
        #toggle-btn.active { background-color: #d32f2f; }
        
        #status { margin-top: 8px; font-size: 0.8rem; color: #888; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div id="speed-display">0 <span class="unit">km/h</span></div>

        <div class="limit-container">
            <div id="visual-limit" class="limit-sign unknown">--</div>
            <div class="limit-info">
                é“è·¯é™é€Ÿ<br>
                <span id="limit-source-text" style="font-size: 0.8rem; color: #f57c00;">(ç­‰å¾… GPS...)</span>
            </div>
        </div>

        <div class="threshold-display">
            è­¦å ±è§¸ç™¼é»: <span id="alarm-threshold-text">--</span> km/h
        </div>
    </div>

    <div class="controls">
        <div class="input-group">
            <label>åŸºç¤é™é€Ÿ (OSMè‡ªå‹•æŠ“å–æˆ–æ‰‹å‹•):</label>
            <input type="number" id="limit-input" value="110">
        </div>

        <div class="input-group">
            <label>è­¦å ±èªéŸ³å…§å®¹:</label>
            <input type="text" id="voice-text" value="åš´é‡è¶…é€Ÿï¼è«‹ç«‹å³ç…è»Šï¼">
        </div>

        <div style="text-align: left; font-size: 0.9rem; margin-bottom: 5px;">
            <input type="checkbox" id="auto-limit-check" checked> 
            <label for="auto-limit-check">è‡ªå‹•æŠ“å–è·¯æ®µé™é€Ÿ (OSM)</label>
        </div>

        <div class="btn-group">
            <button id="test-btn">ğŸ”Š æ¸¬è©¦</button>
            <button id="toggle-btn">ğŸš€ å•Ÿå‹•</button>
        </div>
        
        <div id="status">æº–å‚™å°±ç·’</div>
    </div>

    <script>
        const speedDisplay = document.getElementById('speed-display');
        const limitInput = document.getElementById('limit-input');
        const visualLimit = document.getElementById('visual-limit');
        const limitSourceText = document.getElementById('limit-source-text');
        const alarmThresholdText = document.getElementById('alarm-threshold-text');
        const voiceTextInput = document.getElementById('voice-text');
        const toggleBtn = document.getElementById('toggle-btn');
        const testBtn = document.getElementById('test-btn');
        const statusDiv = document.getElementById('status');
        const autoLimitCheck = document.getElementById('auto-limit-check');
        const body = document.body;

        let watchId = null;
        let wakeLock = null;
        let lastSpeakTime = 0;
        let isMonitoring = false;
        let lastOsmCheckTime = 0;
        
        // è¨­å®šå¯¬é™å€¼ (è¶…éæ­¤æ•¸å€¼æ‰å«)
        const TOLERANCE = 38; 

        const synth = window.speechSynthesis;

        // åˆå§‹åŒ–é¡¯ç¤º
        updateThresholdDisplay();

        // --- äº‹ä»¶ç¶å®š ---
        testBtn.addEventListener('click', () => {
            speak(voiceTextInput.value || "æ¸¬è©¦èªéŸ³", true);
        });

        toggleBtn.addEventListener('click', () => {
            if (!isMonitoring) startMonitoring();
            else stopMonitoring();
        });

        // ç•¶åŸºç¤é™é€Ÿæ”¹è®Šæ™‚ï¼ŒåŒæ­¥æ›´æ–°è­¦å ±é–€æª»é¡¯ç¤º
        limitInput.addEventListener('input', () => {
            updateVisualSign(limitInput.value, false);
            updateThresholdDisplay();
        });

        // --- åŠŸèƒ½å‡½å¼ ---
        function updateThresholdDisplay() {
            const base = parseInt(limitInput.value) || 0;
            // é¡¯ç¤º åŸºç¤ + 38
            alarmThresholdText.textContent = base + TOLERANCE;
        }

        async function startMonitoring() {
            speak("æ‰£ç‰Œé˜²ç¦¦ç³»çµ±å•Ÿå‹•", true);
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}

            if (navigator.geolocation) {
                statusDiv.textContent = "å®šä½ä¸­...";
                watchId = navigator.geolocation.watchPosition(updatePosition, handleError, {
                    enableHighAccuracy: true, timeout: 5000, maximumAge: 0
                });
                isMonitoring = true;
                toggleBtn.textContent = "ğŸ›‘ åœæ­¢";
                toggleBtn.classList.add('active');
            } else {
                alert("ä¸æ”¯æ´ GPS");
            }
        }

        function stopMonitoring() {
            if (watchId !== null) navigator.geolocation.clearWatch(watchId);
            if (wakeLock !== null) wakeLock.release();
            isMonitoring = false;
            toggleBtn.textContent = "ğŸš€ å•Ÿå‹•";
            toggleBtn.classList.remove('active');
            speedDisplay.innerHTML = `0 <span class="unit">km/h</span>`;
            body.classList.remove('danger');
            statusDiv.textContent = "å·²æš«åœ";
        }

        function updatePosition(position) {
            let speedMps = position.coords.speed;
            if (speedMps === null || speedMps < 0) speedMps = 0;
            const speedKmh = speedMps * 3.6;

            speedDisplay.innerHTML = `${Math.round(speedKmh)} <span class="unit">km/h</span>`;
            statusDiv.textContent = `ç²¾ç¢ºåº¦: Â±${Math.round(position.coords.accuracy)}m`;

            // è‡ªå‹•é™é€Ÿ API (æ¯15ç§’ & æ™‚é€Ÿ>10)
            const now = Date.now();
            if (autoLimitCheck.checked && (now - lastOsmCheckTime > 15000) && speedKmh > 10) {
                fetchSpeedLimit(position.coords.latitude, position.coords.longitude);
                lastOsmCheckTime = now;
            }

            checkOverSpeed(speedKmh);
        }

        function checkOverSpeed(currentSpeed) {
            const baseLimit = parseFloat(limitInput.value);
            // æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ï¼š è§¸ç™¼é» = åŸºç¤é™é€Ÿ + 38
            const alarmTrigger = baseLimit + TOLERANCE; 

            if (currentSpeed > alarmTrigger) {
                body.classList.add('danger');
                const now = Date.now();
                if (now - lastSpeakTime > 3000) {
                    speak(voiceTextInput.value);
                    lastSpeakTime = now;
                }
            } else {
                body.classList.remove('danger');
            }
        }

        async function fetchSpeedLimit(lat, lon) {
            console.log(`ğŸŒ æŸ¥è©¢åº§æ¨™: ${lat}, ${lon}`);
            limitSourceText.textContent = "æ›´æ–°ä¸­...";
            
            const query = `[out:json];way[maxspeed](around:20,${lat},${lon});out tags;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.elements && data.elements.length > 0) {
                    let maxspeed = data.elements[0].tags.maxspeed;
                    let limitNumber = parseInt(maxspeed);
                    if (maxspeed.includes("mph")) limitNumber = Math.round(limitNumber * 1.609);

                    if (!isNaN(limitNumber)) {
                        limitInput.value = limitNumber; 
                        updateVisualSign(limitNumber, true);
                        updateThresholdDisplay(); // é‡è¦ï¼šæ›´æ–°è­¦å ±é–€æª»é¡¯ç¤º
                        console.log(`âœ… é™é€Ÿæ›´æ–°: ${limitNumber}`);
                    }
                } else {
                    limitSourceText.textContent = "ç„¡è³‡æ–™ (ç¶­æŒè¨­å®š)";
                    updateVisualSign(limitInput.value, false);
                }
            } catch (err) {
                console.error("API Error", err);
                limitSourceText.textContent = "é€£ç·šå¤±æ•—";
            }
        }

        function updateVisualSign(val, isAuto) {
            if (val && val > 0) {
                visualLimit.textContent = val;
                visualLimit.classList.remove('unknown');
                if (isAuto) {
                    limitSourceText.innerHTML = "OSM è‡ªå‹•æ›´æ–°";
                    limitSourceText.style.color = "#4caf50";
                } else {
                    limitSourceText.innerHTML = "æ‰‹å‹• / ä¸Šæ¬¡è¨­å®š";
                    limitSourceText.style.color = "#aaa";
                }
            } else {
                visualLimit.textContent = "--";
                visualLimit.classList.add('unknown');
            }
        }

        function speak(text, force = false) {
            if (synth.speaking && !force) return;
            if (force) synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.1; 
            const voices = synth.getVoices();
            const targetVoice = voices.find(v => v.name.includes("Google") && v.lang.includes("zh")) 
                             || voices.find(v => v.lang.includes("zh"));     
            if (targetVoice) utterance.voice = targetVoice;
            synth.speak(utterance);
        }

        function handleError(error) {
            console.warn(`GPS Error: ${error.message}`);
            statusDiv.textContent = "âŒ ç„¡æ³•å–å¾— GPS ä½ç½®";
        }
        
        window.speechSynthesis.onvoiceschanged = () => {};
    </script>
</body>
</html>
